import e from"stream";import t from"zlib";import r from"fs";import n from"path";import i from"os";import s from"net";import o from"tls";import a,{randomUUID as h}from"crypto";import c from"events";import f from"https";import l from"http";import u from"url";const d=new TextEncoder;function p(){const e=new Date;return` ${e.getHours()}h ${e.getMinutes()}m :${e.getSeconds()}s `}function m(e){if(!e)return 0;let t=0;return t="string"==typeof e?d.encode(e).length:"number"==typeof e?1:e.byteLength?e.byteLength:(new TextEncoder).encode(e).length,t}function g(e){var t={exports:{}};return e(t,t.exports),t.exports}function y(e){throw new Error('Could not dynamically require "'+e+'". Please configure the dynamicRequireTargets option of @rollup/plugin-commonjs appropriately for this require call to behave properly.')}new TextDecoder;for(var _=function(e){var t=O(e),r=t[0],n=t[1];return 3*(r+n)/4-n},b=function(e){var t,r,n=O(e),i=n[0],s=n[1],o=new S(function(e,t,r){return 3*(t+r)/4-r}(0,i,s)),a=0,h=s>0?i-4:i;for(r=0;r<h;r+=4)t=E[e.charCodeAt(r)]<<18|E[e.charCodeAt(r+1)]<<12|E[e.charCodeAt(r+2)]<<6|E[e.charCodeAt(r+3)],o[a++]=t>>16&255,o[a++]=t>>8&255,o[a++]=255&t;2===s&&(t=E[e.charCodeAt(r)]<<2|E[e.charCodeAt(r+1)]>>4,o[a++]=255&t);1===s&&(t=E[e.charCodeAt(r)]<<10|E[e.charCodeAt(r+1)]<<4|E[e.charCodeAt(r+2)]>>2,o[a++]=t>>8&255,o[a++]=255&t);return o},w=function(e){for(var t,r=e.length,n=r%3,i=[],s=16383,o=0,a=r-n;o<a;o+=s)i.push(L(e,o,o+s>a?a:o+s));1===n?(t=e[r-1],i.push(v[t>>2]+v[t<<4&63]+"==")):2===n&&(t=(e[r-2]<<8)+e[r-1],i.push(v[t>>10]+v[t>>4&63]+v[t<<2&63]+"="));return i.join("")},v=[],E=[],S="undefined"!=typeof Uint8Array?Uint8Array:Array,x="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",k=0,B=x.length;k<B;++k)v[k]=x[k],E[x.charCodeAt(k)]=k;function O(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var r=e.indexOf("=");return-1===r&&(r=t),[r,r===t?0:4-r%4]}function L(e,t,r){for(var n,i,s=[],o=t;o<r;o+=3)n=(e[o]<<16&16711680)+(e[o+1]<<8&65280)+(255&e[o+2]),s.push(v[(i=n)>>18&63]+v[i>>12&63]+v[i>>6&63]+v[63&i]);return s.join("")}E["-".charCodeAt(0)]=62,E["_".charCodeAt(0)]=63;var I={byteLength:_,toByteArray:b,fromByteArray:w},T=function(e,t,r,n,i){var s,o,a=8*i-n-1,h=(1<<a)-1,c=h>>1,f=-7,l=r?i-1:0,u=r?-1:1,d=e[t+l];for(l+=u,s=d&(1<<-f)-1,d>>=-f,f+=a;f>0;s=256*s+e[t+l],l+=u,f-=8);for(o=s&(1<<-f)-1,s>>=-f,f+=n;f>0;o=256*o+e[t+l],l+=u,f-=8);if(0===s)s=1-c;else{if(s===h)return o?NaN:1/0*(d?-1:1);o+=Math.pow(2,n),s-=c}return(d?-1:1)*o*Math.pow(2,s-n)},C=function(e,t,r,n,i,s){var o,a,h,c=8*s-i-1,f=(1<<c)-1,l=f>>1,u=23===i?Math.pow(2,-24)-Math.pow(2,-77):0,d=n?0:s-1,p=n?1:-1,m=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,o=f):(o=Math.floor(Math.log(t)/Math.LN2),t*(h=Math.pow(2,-o))<1&&(o--,h*=2),(t+=o+l>=1?u/h:u*Math.pow(2,1-l))*h>=2&&(o++,h/=2),o+l>=f?(a=0,o=f):o+l>=1?(a=(t*h-1)*Math.pow(2,i),o+=l):(a=t*Math.pow(2,l-1)*Math.pow(2,i),o=0));i>=8;e[r+d]=255&a,d+=p,a/=256,i-=8);for(o=o<<i|a,c+=i;c>0;e[r+d]=255&o,d+=p,o/=256,c-=8);e[r+d-p]|=128*m},N=g((function(e,t){const r="function"==typeof Symbol&&"function"==typeof Symbol.for?Symbol.for("nodejs.util.inspect.custom"):null;t.Buffer=s,t.SlowBuffer=function(e){+e!=e&&(e=0);return s.alloc(+e)},t.INSPECT_MAX_BYTES=50;const n=2147483647;function i(e){if(e>n)throw new RangeError('The value "'+e+'" is invalid for option "size"');const t=new Uint8Array(e);return Object.setPrototypeOf(t,s.prototype),t}function s(e,t,r){if("number"==typeof e){if("string"==typeof t)throw new TypeError('The "string" argument must be of type string. Received type number');return h(e)}return o(e,t,r)}function o(e,t,r){if("string"==typeof e)return function(e,t){"string"==typeof t&&""!==t||(t="utf8");if(!s.isEncoding(t))throw new TypeError("Unknown encoding: "+t);const r=0|u(e,t);let n=i(r);const o=n.write(e,t);o!==r&&(n=n.slice(0,o));return n}(e,t);if(ArrayBuffer.isView(e))return function(e){if(J(e,Uint8Array)){const t=new Uint8Array(e);return f(t.buffer,t.byteOffset,t.byteLength)}return c(e)}(e);if(null==e)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e);if(J(e,ArrayBuffer)||e&&J(e.buffer,ArrayBuffer))return f(e,t,r);if("undefined"!=typeof SharedArrayBuffer&&(J(e,SharedArrayBuffer)||e&&J(e.buffer,SharedArrayBuffer)))return f(e,t,r);if("number"==typeof e)throw new TypeError('The "value" argument must not be of type number. Received type number');const n=e.valueOf&&e.valueOf();if(null!=n&&n!==e)return s.from(n,t,r);const o=function(e){if(s.isBuffer(e)){const t=0|l(e.length),r=i(t);return 0===r.length||e.copy(r,0,0,t),r}if(void 0!==e.length)return"number"!=typeof e.length||X(e.length)?i(0):c(e);if("Buffer"===e.type&&Array.isArray(e.data))return c(e.data)}(e);if(o)return o;if("undefined"!=typeof Symbol&&null!=Symbol.toPrimitive&&"function"==typeof e[Symbol.toPrimitive])return s.from(e[Symbol.toPrimitive]("string"),t,r);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e)}function a(e){if("number"!=typeof e)throw new TypeError('"size" argument must be of type number');if(e<0)throw new RangeError('The value "'+e+'" is invalid for option "size"')}function h(e){return a(e),i(e<0?0:0|l(e))}function c(e){const t=e.length<0?0:0|l(e.length),r=i(t);for(let n=0;n<t;n+=1)r[n]=255&e[n];return r}function f(e,t,r){if(t<0||e.byteLength<t)throw new RangeError('"offset" is outside of buffer bounds');if(e.byteLength<t+(r||0))throw new RangeError('"length" is outside of buffer bounds');let n;return n=void 0===t&&void 0===r?new Uint8Array(e):void 0===r?new Uint8Array(e,t):new Uint8Array(e,t,r),Object.setPrototypeOf(n,s.prototype),n}function l(e){if(e>=n)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+n.toString(16)+" bytes");return 0|e}function u(e,t){if(s.isBuffer(e))return e.length;if(ArrayBuffer.isView(e)||J(e,ArrayBuffer))return e.byteLength;if("string"!=typeof e)throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof e);const r=e.length,n=arguments.length>2&&!0===arguments[2];if(!n&&0===r)return 0;let i=!1;for(;;)switch(t){case"ascii":case"latin1":case"binary":return r;case"utf8":case"utf-8":return q(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*r;case"hex":return r>>>1;case"base64":return H(e).length;default:if(i)return n?-1:q(e).length;t=(""+t).toLowerCase(),i=!0}}function d(e,t,r){let n=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===r||r>this.length)&&(r=this.length),r<=0)return"";if((r>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return O(this,t,r);case"utf8":case"utf-8":return S(this,t,r);case"ascii":return k(this,t,r);case"latin1":case"binary":return B(this,t,r);case"base64":return E(this,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return L(this,t,r);default:if(n)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),n=!0}}function p(e,t,r){const n=e[t];e[t]=e[r],e[r]=n}function m(e,t,r,n,i){if(0===e.length)return-1;if("string"==typeof r?(n=r,r=0):r>2147483647?r=2147483647:r<-2147483648&&(r=-2147483648),X(r=+r)&&(r=i?0:e.length-1),r<0&&(r=e.length+r),r>=e.length){if(i)return-1;r=e.length-1}else if(r<0){if(!i)return-1;r=0}if("string"==typeof t&&(t=s.from(t,n)),s.isBuffer(t))return 0===t.length?-1:g(e,t,r,n,i);if("number"==typeof t)return t&=255,"function"==typeof Uint8Array.prototype.indexOf?i?Uint8Array.prototype.indexOf.call(e,t,r):Uint8Array.prototype.lastIndexOf.call(e,t,r):g(e,[t],r,n,i);throw new TypeError("val must be string, number or Buffer")}function g(e,t,r,n,i){let s,o=1,a=e.length,h=t.length;if(void 0!==n&&("ucs2"===(n=String(n).toLowerCase())||"ucs-2"===n||"utf16le"===n||"utf-16le"===n)){if(e.length<2||t.length<2)return-1;o=2,a/=2,h/=2,r/=2}function c(e,t){return 1===o?e[t]:e.readUInt16BE(t*o)}if(i){let n=-1;for(s=r;s<a;s++)if(c(e,s)===c(t,-1===n?0:s-n)){if(-1===n&&(n=s),s-n+1===h)return n*o}else-1!==n&&(s-=s-n),n=-1}else for(r+h>a&&(r=a-h),s=r;s>=0;s--){let r=!0;for(let n=0;n<h;n++)if(c(e,s+n)!==c(t,n)){r=!1;break}if(r)return s}return-1}function y(e,t,r,n){r=Number(r)||0;const i=e.length-r;n?(n=Number(n))>i&&(n=i):n=i;const s=t.length;let o;for(n>s/2&&(n=s/2),o=0;o<n;++o){const n=parseInt(t.substr(2*o,2),16);if(X(n))return o;e[r+o]=n}return o}function _(e,t,r,n){return Y(q(t,e.length-r),e,r,n)}function b(e,t,r,n){return Y(function(e){const t=[];for(let r=0;r<e.length;++r)t.push(255&e.charCodeAt(r));return t}(t),e,r,n)}function w(e,t,r,n){return Y(H(t),e,r,n)}function v(e,t,r,n){return Y(function(e,t){let r,n,i;const s=[];for(let o=0;o<e.length&&!((t-=2)<0);++o)r=e.charCodeAt(o),n=r>>8,i=r%256,s.push(i),s.push(n);return s}(t,e.length-r),e,r,n)}function E(e,t,r){return 0===t&&r===e.length?I.fromByteArray(e):I.fromByteArray(e.slice(t,r))}function S(e,t,r){r=Math.min(e.length,r);const n=[];let i=t;for(;i<r;){const t=e[i];let s=null,o=t>239?4:t>223?3:t>191?2:1;if(i+o<=r){let r,n,a,h;switch(o){case 1:t<128&&(s=t);break;case 2:r=e[i+1],128==(192&r)&&(h=(31&t)<<6|63&r,h>127&&(s=h));break;case 3:r=e[i+1],n=e[i+2],128==(192&r)&&128==(192&n)&&(h=(15&t)<<12|(63&r)<<6|63&n,h>2047&&(h<55296||h>57343)&&(s=h));break;case 4:r=e[i+1],n=e[i+2],a=e[i+3],128==(192&r)&&128==(192&n)&&128==(192&a)&&(h=(15&t)<<18|(63&r)<<12|(63&n)<<6|63&a,h>65535&&h<1114112&&(s=h))}}null===s?(s=65533,o=1):s>65535&&(s-=65536,n.push(s>>>10&1023|55296),s=56320|1023&s),n.push(s),i+=o}return function(e){const t=e.length;if(t<=x)return String.fromCharCode.apply(String,e);let r="",n=0;for(;n<t;)r+=String.fromCharCode.apply(String,e.slice(n,n+=x));return r}(n)}t.kMaxLength=n,s.TYPED_ARRAY_SUPPORT=function(){try{const e=new Uint8Array(1),t={foo:function(){return 42}};return Object.setPrototypeOf(t,Uint8Array.prototype),Object.setPrototypeOf(e,t),42===e.foo()}catch(e){return!1}}(),s.TYPED_ARRAY_SUPPORT||"undefined"==typeof console||"function"!=typeof console.error||console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support."),Object.defineProperty(s.prototype,"parent",{enumerable:!0,get:function(){if(s.isBuffer(this))return this.buffer}}),Object.defineProperty(s.prototype,"offset",{enumerable:!0,get:function(){if(s.isBuffer(this))return this.byteOffset}}),s.poolSize=8192,s.from=function(e,t,r){return o(e,t,r)},Object.setPrototypeOf(s.prototype,Uint8Array.prototype),Object.setPrototypeOf(s,Uint8Array),s.alloc=function(e,t,r){return function(e,t,r){return a(e),e<=0?i(e):void 0!==t?"string"==typeof r?i(e).fill(t,r):i(e).fill(t):i(e)}(e,t,r)},s.allocUnsafe=function(e){return h(e)},s.allocUnsafeSlow=function(e){return h(e)},s.isBuffer=function(e){return null!=e&&!0===e._isBuffer&&e!==s.prototype},s.compare=function(e,t){if(J(e,Uint8Array)&&(e=s.from(e,e.offset,e.byteLength)),J(t,Uint8Array)&&(t=s.from(t,t.offset,t.byteLength)),!s.isBuffer(e)||!s.isBuffer(t))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(e===t)return 0;let r=e.length,n=t.length;for(let i=0,s=Math.min(r,n);i<s;++i)if(e[i]!==t[i]){r=e[i],n=t[i];break}return r<n?-1:n<r?1:0},s.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},s.concat=function(e,t){if(!Array.isArray(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return s.alloc(0);let r;if(void 0===t)for(t=0,r=0;r<e.length;++r)t+=e[r].length;const n=s.allocUnsafe(t);let i=0;for(r=0;r<e.length;++r){let t=e[r];if(J(t,Uint8Array))i+t.length>n.length?(s.isBuffer(t)||(t=s.from(t)),t.copy(n,i)):Uint8Array.prototype.set.call(n,t,i);else{if(!s.isBuffer(t))throw new TypeError('"list" argument must be an Array of Buffers');t.copy(n,i)}i+=t.length}return n},s.byteLength=u,s.prototype._isBuffer=!0,s.prototype.swap16=function(){const e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let t=0;t<e;t+=2)p(this,t,t+1);return this},s.prototype.swap32=function(){const e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let t=0;t<e;t+=4)p(this,t,t+3),p(this,t+1,t+2);return this},s.prototype.swap64=function(){const e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let t=0;t<e;t+=8)p(this,t,t+7),p(this,t+1,t+6),p(this,t+2,t+5),p(this,t+3,t+4);return this},s.prototype.toString=function(){const e=this.length;return 0===e?"":0===arguments.length?S(this,0,e):d.apply(this,arguments)},s.prototype.toLocaleString=s.prototype.toString,s.prototype.equals=function(e){if(!s.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===s.compare(this,e)},s.prototype.inspect=function(){let e="";const r=t.INSPECT_MAX_BYTES;return e=this.toString("hex",0,r).replace(/(.{2})/g,"$1 ").trim(),this.length>r&&(e+=" ... "),"<Buffer "+e+">"},r&&(s.prototype[r]=s.prototype.inspect),s.prototype.compare=function(e,t,r,n,i){if(J(e,Uint8Array)&&(e=s.from(e,e.offset,e.byteLength)),!s.isBuffer(e))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof e);if(void 0===t&&(t=0),void 0===r&&(r=e?e.length:0),void 0===n&&(n=0),void 0===i&&(i=this.length),t<0||r>e.length||n<0||i>this.length)throw new RangeError("out of range index");if(n>=i&&t>=r)return 0;if(n>=i)return-1;if(t>=r)return 1;if(this===e)return 0;let o=(i>>>=0)-(n>>>=0),a=(r>>>=0)-(t>>>=0);const h=Math.min(o,a),c=this.slice(n,i),f=e.slice(t,r);for(let e=0;e<h;++e)if(c[e]!==f[e]){o=c[e],a=f[e];break}return o<a?-1:a<o?1:0},s.prototype.includes=function(e,t,r){return-1!==this.indexOf(e,t,r)},s.prototype.indexOf=function(e,t,r){return m(this,e,t,r,!0)},s.prototype.lastIndexOf=function(e,t,r){return m(this,e,t,r,!1)},s.prototype.write=function(e,t,r,n){if(void 0===t)n="utf8",r=this.length,t=0;else if(void 0===r&&"string"==typeof t)n=t,r=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t>>>=0,isFinite(r)?(r>>>=0,void 0===n&&(n="utf8")):(n=r,r=void 0)}const i=this.length-t;if((void 0===r||r>i)&&(r=i),e.length>0&&(r<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");n||(n="utf8");let s=!1;for(;;)switch(n){case"hex":return y(this,e,t,r);case"utf8":case"utf-8":return _(this,e,t,r);case"ascii":case"latin1":case"binary":return b(this,e,t,r);case"base64":return w(this,e,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return v(this,e,t,r);default:if(s)throw new TypeError("Unknown encoding: "+n);n=(""+n).toLowerCase(),s=!0}},s.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};const x=4096;function k(e,t,r){let n="";r=Math.min(e.length,r);for(let i=t;i<r;++i)n+=String.fromCharCode(127&e[i]);return n}function B(e,t,r){let n="";r=Math.min(e.length,r);for(let i=t;i<r;++i)n+=String.fromCharCode(e[i]);return n}function O(e,t,r){const n=e.length;(!t||t<0)&&(t=0),(!r||r<0||r>n)&&(r=n);let i="";for(let n=t;n<r;++n)i+=K[e[n]];return i}function L(e,t,r){const n=e.slice(t,r);let i="";for(let e=0;e<n.length-1;e+=2)i+=String.fromCharCode(n[e]+256*n[e+1]);return i}function N(e,t,r){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>r)throw new RangeError("Trying to access beyond buffer length")}function U(e,t,r,n,i,o){if(!s.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>i||t<o)throw new RangeError('"value" argument is out of bounds');if(r+n>e.length)throw new RangeError("Index out of range")}function A(e,t,r,n,i){W(t,n,i,e,r,7);let s=Number(t&BigInt(4294967295));e[r++]=s,s>>=8,e[r++]=s,s>>=8,e[r++]=s,s>>=8,e[r++]=s;let o=Number(t>>BigInt(32)&BigInt(4294967295));return e[r++]=o,o>>=8,e[r++]=o,o>>=8,e[r++]=o,o>>=8,e[r++]=o,r}function R(e,t,r,n,i){W(t,n,i,e,r,7);let s=Number(t&BigInt(4294967295));e[r+7]=s,s>>=8,e[r+6]=s,s>>=8,e[r+5]=s,s>>=8,e[r+4]=s;let o=Number(t>>BigInt(32)&BigInt(4294967295));return e[r+3]=o,o>>=8,e[r+2]=o,o>>=8,e[r+1]=o,o>>=8,e[r]=o,r+8}function M(e,t,r,n,i,s){if(r+n>e.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("Index out of range")}function P(e,t,r,n,i){return t=+t,r>>>=0,i||M(e,0,r,4),C(e,t,r,n,23,4),r+4}function D(e,t,r,n,i){return t=+t,r>>>=0,i||M(e,0,r,8),C(e,t,r,n,52,8),r+8}s.prototype.slice=function(e,t){const r=this.length;(e=~~e)<0?(e+=r)<0&&(e=0):e>r&&(e=r),(t=void 0===t?r:~~t)<0?(t+=r)<0&&(t=0):t>r&&(t=r),t<e&&(t=e);const n=this.subarray(e,t);return Object.setPrototypeOf(n,s.prototype),n},s.prototype.readUintLE=s.prototype.readUIntLE=function(e,t,r){e>>>=0,t>>>=0,r||N(e,t,this.length);let n=this[e],i=1,s=0;for(;++s<t&&(i*=256);)n+=this[e+s]*i;return n},s.prototype.readUintBE=s.prototype.readUIntBE=function(e,t,r){e>>>=0,t>>>=0,r||N(e,t,this.length);let n=this[e+--t],i=1;for(;t>0&&(i*=256);)n+=this[e+--t]*i;return n},s.prototype.readUint8=s.prototype.readUInt8=function(e,t){return e>>>=0,t||N(e,1,this.length),this[e]},s.prototype.readUint16LE=s.prototype.readUInt16LE=function(e,t){return e>>>=0,t||N(e,2,this.length),this[e]|this[e+1]<<8},s.prototype.readUint16BE=s.prototype.readUInt16BE=function(e,t){return e>>>=0,t||N(e,2,this.length),this[e]<<8|this[e+1]},s.prototype.readUint32LE=s.prototype.readUInt32LE=function(e,t){return e>>>=0,t||N(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},s.prototype.readUint32BE=s.prototype.readUInt32BE=function(e,t){return e>>>=0,t||N(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},s.prototype.readBigUInt64LE=Z((function(e){G(e>>>=0,"offset");const t=this[e],r=this[e+7];void 0!==t&&void 0!==r||V(e,this.length-8);const n=t+256*this[++e]+65536*this[++e]+this[++e]*2**24,i=this[++e]+256*this[++e]+65536*this[++e]+r*2**24;return BigInt(n)+(BigInt(i)<<BigInt(32))})),s.prototype.readBigUInt64BE=Z((function(e){G(e>>>=0,"offset");const t=this[e],r=this[e+7];void 0!==t&&void 0!==r||V(e,this.length-8);const n=t*2**24+65536*this[++e]+256*this[++e]+this[++e],i=this[++e]*2**24+65536*this[++e]+256*this[++e]+r;return(BigInt(n)<<BigInt(32))+BigInt(i)})),s.prototype.readIntLE=function(e,t,r){e>>>=0,t>>>=0,r||N(e,t,this.length);let n=this[e],i=1,s=0;for(;++s<t&&(i*=256);)n+=this[e+s]*i;return i*=128,n>=i&&(n-=Math.pow(2,8*t)),n},s.prototype.readIntBE=function(e,t,r){e>>>=0,t>>>=0,r||N(e,t,this.length);let n=t,i=1,s=this[e+--n];for(;n>0&&(i*=256);)s+=this[e+--n]*i;return i*=128,s>=i&&(s-=Math.pow(2,8*t)),s},s.prototype.readInt8=function(e,t){return e>>>=0,t||N(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},s.prototype.readInt16LE=function(e,t){e>>>=0,t||N(e,2,this.length);const r=this[e]|this[e+1]<<8;return 32768&r?4294901760|r:r},s.prototype.readInt16BE=function(e,t){e>>>=0,t||N(e,2,this.length);const r=this[e+1]|this[e]<<8;return 32768&r?4294901760|r:r},s.prototype.readInt32LE=function(e,t){return e>>>=0,t||N(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},s.prototype.readInt32BE=function(e,t){return e>>>=0,t||N(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},s.prototype.readBigInt64LE=Z((function(e){G(e>>>=0,"offset");const t=this[e],r=this[e+7];void 0!==t&&void 0!==r||V(e,this.length-8);const n=this[e+4]+256*this[e+5]+65536*this[e+6]+(r<<24);return(BigInt(n)<<BigInt(32))+BigInt(t+256*this[++e]+65536*this[++e]+this[++e]*2**24)})),s.prototype.readBigInt64BE=Z((function(e){G(e>>>=0,"offset");const t=this[e],r=this[e+7];void 0!==t&&void 0!==r||V(e,this.length-8);const n=(t<<24)+65536*this[++e]+256*this[++e]+this[++e];return(BigInt(n)<<BigInt(32))+BigInt(this[++e]*2**24+65536*this[++e]+256*this[++e]+r)})),s.prototype.readFloatLE=function(e,t){return e>>>=0,t||N(e,4,this.length),T(this,e,!0,23,4)},s.prototype.readFloatBE=function(e,t){return e>>>=0,t||N(e,4,this.length),T(this,e,!1,23,4)},s.prototype.readDoubleLE=function(e,t){return e>>>=0,t||N(e,8,this.length),T(this,e,!0,52,8)},s.prototype.readDoubleBE=function(e,t){return e>>>=0,t||N(e,8,this.length),T(this,e,!1,52,8)},s.prototype.writeUintLE=s.prototype.writeUIntLE=function(e,t,r,n){if(e=+e,t>>>=0,r>>>=0,!n){U(this,e,t,r,Math.pow(2,8*r)-1,0)}let i=1,s=0;for(this[t]=255&e;++s<r&&(i*=256);)this[t+s]=e/i&255;return t+r},s.prototype.writeUintBE=s.prototype.writeUIntBE=function(e,t,r,n){if(e=+e,t>>>=0,r>>>=0,!n){U(this,e,t,r,Math.pow(2,8*r)-1,0)}let i=r-1,s=1;for(this[t+i]=255&e;--i>=0&&(s*=256);)this[t+i]=e/s&255;return t+r},s.prototype.writeUint8=s.prototype.writeUInt8=function(e,t,r){return e=+e,t>>>=0,r||U(this,e,t,1,255,0),this[t]=255&e,t+1},s.prototype.writeUint16LE=s.prototype.writeUInt16LE=function(e,t,r){return e=+e,t>>>=0,r||U(this,e,t,2,65535,0),this[t]=255&e,this[t+1]=e>>>8,t+2},s.prototype.writeUint16BE=s.prototype.writeUInt16BE=function(e,t,r){return e=+e,t>>>=0,r||U(this,e,t,2,65535,0),this[t]=e>>>8,this[t+1]=255&e,t+2},s.prototype.writeUint32LE=s.prototype.writeUInt32LE=function(e,t,r){return e=+e,t>>>=0,r||U(this,e,t,4,4294967295,0),this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e,t+4},s.prototype.writeUint32BE=s.prototype.writeUInt32BE=function(e,t,r){return e=+e,t>>>=0,r||U(this,e,t,4,4294967295,0),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},s.prototype.writeBigUInt64LE=Z((function(e,t=0){return A(this,e,t,BigInt(0),BigInt("0xffffffffffffffff"))})),s.prototype.writeBigUInt64BE=Z((function(e,t=0){return R(this,e,t,BigInt(0),BigInt("0xffffffffffffffff"))})),s.prototype.writeIntLE=function(e,t,r,n){if(e=+e,t>>>=0,!n){const n=Math.pow(2,8*r-1);U(this,e,t,r,n-1,-n)}let i=0,s=1,o=0;for(this[t]=255&e;++i<r&&(s*=256);)e<0&&0===o&&0!==this[t+i-1]&&(o=1),this[t+i]=(e/s>>0)-o&255;return t+r},s.prototype.writeIntBE=function(e,t,r,n){if(e=+e,t>>>=0,!n){const n=Math.pow(2,8*r-1);U(this,e,t,r,n-1,-n)}let i=r-1,s=1,o=0;for(this[t+i]=255&e;--i>=0&&(s*=256);)e<0&&0===o&&0!==this[t+i+1]&&(o=1),this[t+i]=(e/s>>0)-o&255;return t+r},s.prototype.writeInt8=function(e,t,r){return e=+e,t>>>=0,r||U(this,e,t,1,127,-128),e<0&&(e=255+e+1),this[t]=255&e,t+1},s.prototype.writeInt16LE=function(e,t,r){return e=+e,t>>>=0,r||U(this,e,t,2,32767,-32768),this[t]=255&e,this[t+1]=e>>>8,t+2},s.prototype.writeInt16BE=function(e,t,r){return e=+e,t>>>=0,r||U(this,e,t,2,32767,-32768),this[t]=e>>>8,this[t+1]=255&e,t+2},s.prototype.writeInt32LE=function(e,t,r){return e=+e,t>>>=0,r||U(this,e,t,4,2147483647,-2147483648),this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24,t+4},s.prototype.writeInt32BE=function(e,t,r){return e=+e,t>>>=0,r||U(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},s.prototype.writeBigInt64LE=Z((function(e,t=0){return A(this,e,t,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))})),s.prototype.writeBigInt64BE=Z((function(e,t=0){return R(this,e,t,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))})),s.prototype.writeFloatLE=function(e,t,r){return P(this,e,t,!0,r)},s.prototype.writeFloatBE=function(e,t,r){return P(this,e,t,!1,r)},s.prototype.writeDoubleLE=function(e,t,r){return D(this,e,t,!0,r)},s.prototype.writeDoubleBE=function(e,t,r){return D(this,e,t,!1,r)},s.prototype.copy=function(e,t,r,n){if(!s.isBuffer(e))throw new TypeError("argument should be a Buffer");if(r||(r=0),n||0===n||(n=this.length),t>=e.length&&(t=e.length),t||(t=0),n>0&&n<r&&(n=r),n===r)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(r<0||r>=this.length)throw new RangeError("Index out of range");if(n<0)throw new RangeError("sourceEnd out of bounds");n>this.length&&(n=this.length),e.length-t<n-r&&(n=e.length-t+r);const i=n-r;return this===e&&"function"==typeof Uint8Array.prototype.copyWithin?this.copyWithin(t,r,n):Uint8Array.prototype.set.call(e,this.subarray(r,n),t),i},s.prototype.fill=function(e,t,r,n){if("string"==typeof e){if("string"==typeof t?(n=t,t=0,r=this.length):"string"==typeof r&&(n=r,r=this.length),void 0!==n&&"string"!=typeof n)throw new TypeError("encoding must be a string");if("string"==typeof n&&!s.isEncoding(n))throw new TypeError("Unknown encoding: "+n);if(1===e.length){const t=e.charCodeAt(0);("utf8"===n&&t<128||"latin1"===n)&&(e=t)}}else"number"==typeof e?e&=255:"boolean"==typeof e&&(e=Number(e));if(t<0||this.length<t||this.length<r)throw new RangeError("Out of range index");if(r<=t)return this;let i;if(t>>>=0,r=void 0===r?this.length:r>>>0,e||(e=0),"number"==typeof e)for(i=t;i<r;++i)this[i]=e;else{const o=s.isBuffer(e)?e:s.from(e,n),a=o.length;if(0===a)throw new TypeError('The value "'+e+'" is invalid for argument "value"');for(i=0;i<r-t;++i)this[i+t]=o[i%a]}return this};const $={};function F(e,t,r){$[e]=class extends r{constructor(){super(),Object.defineProperty(this,"message",{value:t.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${e}]`,this.stack,delete this.name}get code(){return e}set code(e){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:e,writable:!0})}toString(){return`${this.name} [${e}]: ${this.message}`}}}function j(e){let t="",r=e.length;const n="-"===e[0]?1:0;for(;r>=n+4;r-=3)t=`_${e.slice(r-3,r)}${t}`;return`${e.slice(0,r)}${t}`}function W(e,t,r,n,i,s){if(e>r||e<t){const n="bigint"==typeof t?"n":"";let i;throw i=s>3?0===t||t===BigInt(0)?`>= 0${n} and < 2${n} ** ${8*(s+1)}${n}`:`>= -(2${n} ** ${8*(s+1)-1}${n}) and < 2 ** ${8*(s+1)-1}${n}`:`>= ${t}${n} and <= ${r}${n}`,new $.ERR_OUT_OF_RANGE("value",i,e)}!function(e,t,r){G(t,"offset"),void 0!==e[t]&&void 0!==e[t+r]||V(t,e.length-(r+1))}(n,i,s)}function G(e,t){if("number"!=typeof e)throw new $.ERR_INVALID_ARG_TYPE(t,"number",e)}function V(e,t,r){if(Math.floor(e)!==e)throw G(e,r),new $.ERR_OUT_OF_RANGE(r||"offset","an integer",e);if(t<0)throw new $.ERR_BUFFER_OUT_OF_BOUNDS;throw new $.ERR_OUT_OF_RANGE(r||"offset",`>= ${r?1:0} and <= ${t}`,e)}F("ERR_BUFFER_OUT_OF_BOUNDS",(function(e){return e?`${e} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"}),RangeError),F("ERR_INVALID_ARG_TYPE",(function(e,t){return`The "${e}" argument must be of type number. Received type ${typeof t}`}),TypeError),F("ERR_OUT_OF_RANGE",(function(e,t,r){let n=`The value of "${e}" is out of range.`,i=r;return Number.isInteger(r)&&Math.abs(r)>2**32?i=j(String(r)):"bigint"==typeof r&&(i=String(r),(r>BigInt(2)**BigInt(32)||r<-(BigInt(2)**BigInt(32)))&&(i=j(i)),i+="n"),n+=` It must be ${t}. Received ${i}`,n}),RangeError);const z=/[^+/0-9A-Za-z-_]/g;function q(e,t){let r;t=t||1/0;const n=e.length;let i=null;const s=[];for(let o=0;o<n;++o){if(r=e.charCodeAt(o),r>55295&&r<57344){if(!i){if(r>56319){(t-=3)>-1&&s.push(239,191,189);continue}if(o+1===n){(t-=3)>-1&&s.push(239,191,189);continue}i=r;continue}if(r<56320){(t-=3)>-1&&s.push(239,191,189),i=r;continue}r=65536+(i-55296<<10|r-56320)}else i&&(t-=3)>-1&&s.push(239,191,189);if(i=null,r<128){if((t-=1)<0)break;s.push(r)}else if(r<2048){if((t-=2)<0)break;s.push(r>>6|192,63&r|128)}else if(r<65536){if((t-=3)<0)break;s.push(r>>12|224,r>>6&63|128,63&r|128)}else{if(!(r<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;s.push(r>>18|240,r>>12&63|128,r>>6&63|128,63&r|128)}}return s}function H(e){return I.toByteArray(function(e){if((e=(e=e.split("=")[0]).trim().replace(z,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function Y(e,t,r,n){let i;for(i=0;i<n&&!(i+r>=t.length||i>=e.length);++i)t[i+r]=e[i];return i}function J(e,t){return e instanceof t||null!=e&&null!=e.constructor&&null!=e.constructor.name&&e.constructor.name===t.name}function X(e){return e!=e}const K=function(){const e="0123456789abcdef",t=new Array(256);for(let r=0;r<16;++r){const n=16*r;for(let i=0;i<16;++i)t[n+i]=e[r]+e[i]}return t}();function Z(e){return"undefined"==typeof BigInt?Q:e}function Q(){throw new Error("BigInt not supported")}}));
/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */const U=new TextEncoder,A=new TextDecoder,R=M;function M(e,t=0){let r;if(void 0===e||"string"!=typeof e||"number"!=typeof t)throw TypeError("invlaid init variablie type name. ");return(e=e.toUpperCase()).includes("8")?(r=N.Buffer.alloc(1),e.includes("I")?r.writeInt8(t):r.writeUint8(t)):e.includes("16")?(r=N.Buffer.alloc(2),e.includes("I")?e.includes("L")?r.writeInt16LE(t):r.writeInt16BE(t):e.includes("L")?r.writeUint16LE(t):r.writeUint16BE(t)):e.includes("32")?(r=N.Buffer.alloc(4),e.includes("I")?e.includes("L")?r.writeInt32LE(t):r.writeInt32BE(t):e.includes("L")?r.writeUint32LE(t):r.writeUint32BE(t)):e.includes("F")?(r=N.Buffer.alloc(4),e.includes("L")?r.writeFloatLE(t):r.writeFloatBE(t)):e.includes("N")?r=N.Buffer.from(String(t)):console.log(`invalid type: ${e} or initvalue: ${t}`),r}const P=function(e,t,r){let n,i="B";if("number"==typeof t)"number"==typeof r?(n=N.Buffer.alloc(t),n.fill(r),i="B"):(n=N.Buffer.from(String(t)),i="N");else if("string"==typeof t&&"number"==typeof r)i=t.toUpperCase(),n=M(t,r);else if("string"==typeof t&&void 0===r)n=N.Buffer.from(t),i="S";else if(t instanceof Uint8Array&&void 0===r)n=t instanceof N.Buffer?t:N.Buffer.from(t);else if(t instanceof ArrayBuffer&&void 0===r)n=N.Buffer.from(t);else if(ArrayBuffer.isView(t))n=N.Buffer.from(t.buffer,t.byteOffset,t.byteLength);else if("object"==typeof t&&void 0===r)n=N.Buffer.from(JSON.stringify(t)),i="O";else{if("boolean"!=typeof t||void 0!==r)throw TypeError("invalid meta buffer type");{const e=t?1:0;n=N.Buffer.from([e]),i="!"}}"string"==typeof e&&e.includes("#")&&(e="");return[e,i,n]};const D=function(...e){let t=0;const r=e.map((e=>{const r=t++;return"number"==typeof e?P(r,"N",e):P(r,e)}));return r.push(P("$","8",r.length)),r};function $(e){if((e=e.toUpperCase()).includes("8"))return e.includes("I")?"int8":"uint8";if(e.includes("16"))return e.includes("I")?e.includes("L")?"int16_le":"int16_be":e.includes("L")?"uint16_le":"uint16_be";if(e.includes("32"))return e.includes("I")?e.includes("L")?"int32_le":"int32_be":e.includes("L")?"uint32_le":"uint32_be";if(e.includes("F"))return e.includes("L")?"float_le":"float_be";if("B"===e)return"buffer";if("S"===e)return"string";if("N"===e)return"number";if("O"===e)return"object";if("!"===e)return"boolean";throw TypeError("invalid data type")}function F(...e){const t=function(e){let t=[];return e.filter((e=>{if(!Array.isArray(e[0]))return e;t=t.concat(e)})).concat(t)}(e);let r=0;const n=[];let i,s,o=0;t.forEach((e=>{const[t,i,s]=e;r+=s.byteLength,("number"==typeof t||t.length>0)&&(i.includes("N")||i.includes("B")||i.includes("S")||i.includes("O")?n.push([t,i,o,s.byteLength]):n.push([t,i,o])),o=r})),n.length>0&&(i=U.encode(JSON.stringify(n)),s=i.byteLength,r=r+s+2);const a=N.Buffer.alloc(r);if(o=0,t.forEach((e=>{const t=e[2];a.set(t,o),o+=t.byteLength})),n.length>0){a.set(i,o);const e=R("16",s);return a.set(e,o+s),a}return a}function j(e,t){const r=t||function(e,t=!1){e instanceof ArrayBuffer&&(e=N.Buffer.from(e));const r=function(e){e instanceof ArrayBuffer&&(e=N.Buffer.from(e));if(e instanceof Uint8Array){if(e.byteLength<=2)return 0;return new DataView(e.buffer,e.byteOffset,e.byteLength).getUint16(e.byteLength-2)}return 0}(e);if(0===r)return;let n=function(e,t){try{const r=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),n=r.byteLength-t-2,i=r.subarray(n,r.byteLength-2),s=A.decode(i),o=JSON.parse(s);if(!Array.isArray(o)||!Array.isArray(o[0]))return;let a=o[0];if(!a)return;if(a.length<3)return;const[h,c,f]=a;if("string"!=typeof c||"number"!=typeof f)return;return o}catch(e){}}(e,r);if(!n)return;return t?(n.forEach((e=>{null==e[3]&&(e[1].includes("8")?e[3]=1:e[1].includes("16")?e[3]=2:e[1].includes("32")||e[1].includes("F")?e[3]=4:e[1].includes("!")&&(e[3]=1)),e[4]=$(e[1])})),n):n}(e);if(!r)return;const n=N.Buffer.from(e),i={};if(r.forEach((e=>{const[t,r,s,o]=e;i[t]=function(e,t,r,n){const i=$(e);if("int8"==i)return t.readInt8(r);if("uint8"===i)return t.readUint8(r);if("int16_le"===i)return t.readInt16LE(r);if("int16_be"===i)return t.readInt16BE(r);if("uint16_le"===i)return t.readUint16LE(r);if("uint16_be"===i)return t.readUint16BE(r);if("int32_le"===i)return t.readInt32LE(r);if("int32_be"===i)return t.readInt32BE(r);if("uint32_le"===i)return t.readUint32LE(r);if("uint32_be"===i)return t.readUint32BE(r);if("float_le"===i)return t.readFloatLE(r);if("float_be"===i)return t.readFloatBE(r);if("buffer"===i)return t.slice(r,r+n);if("string"===i){const e=t.slice(r,r+n);return A.decode(e)}if("number"===i){const e=t.slice(r,r+n);return Number(A.decode(e))}if("object"!==i){if("boolean"===i)return 1===t.readInt8(r);throw TypeError("invalid data")}{const e=t.slice(r,r+n);try{return JSON.parse(A.decode(e))}catch(e){console.log("err. obj parse")}}}(r,n,s,o)})),i.$){const e=i.$,t=[];for(let r=0;r<e;r++)t.push(i[r]);i.args=t,i.$=i.args}return i}const W=G;function G(e,t=!1){if(void 0===e)throw TypeError("Invalid data type: Undefined");if("string"==typeof e)return U.encode(e);if("number"==typeof e)return Uint8Array.from([e]);if(e instanceof ArrayBuffer){if(t)return new Uint8Array(e);{const t=new Uint8Array(e),r=new Uint8Array(e.byteLength);return r.set(t),r}}if(ArrayBuffer.isView(e)){if(t)return new Uint8Array(e.buffer,e.byteOffset,e.byteLength);{const t=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),r=new Uint8Array(e.byteLength);return r.set(t),r}}return U.encode(JSON.stringify(e))}const V=function(...e){try{let t=0,r=0;const n=e.map((e=>G(e)));n.forEach((e=>{t+=e.byteLength}));const i=new Uint8Array(t);return n.forEach((e=>{i.set(e,r),r+=e.byteLength})),i}catch(e){console.log(e)}};var z=g((function(e,t){e.exports=function(){function e(t,r,n){function i(o,a){if(!r[o]){if(!t[o]){if(!a&&y)return y(o);if(s)return s(o,!0);var h=new Error("Cannot find module '"+o+"'");throw h.code="MODULE_NOT_FOUND",h}var c=r[o]={exports:{}};t[o][0].call(c.exports,(function(e){return i(t[o][1][e]||e)}),c,c.exports,e,t,r,n)}return r[o].exports}for(var s=y,o=0;o<n.length;o++)i(n[o]);return i}return e}()({1:[function(e,t,r){var n=Object.prototype.hasOwnProperty,i="~";function s(){}function o(e,t,r){this.fn=e,this.context=t,this.once=r||!1}function a(e,t,r,n,s){if("function"!=typeof r)throw new TypeError("The listener must be a function");var a=new o(r,n||e,s),h=i?i+t:t;return e._events[h]?e._events[h].fn?e._events[h]=[e._events[h],a]:e._events[h].push(a):(e._events[h]=a,e._eventsCount++),e}function h(e,t){0==--e._eventsCount?e._events=new s:delete e._events[t]}function c(){this._events=new s,this._eventsCount=0}Object.create&&(s.prototype=Object.create(null),(new s).__proto__||(i=!1)),c.prototype.eventNames=function(){var e,t,r=[];if(0===this._eventsCount)return r;for(t in e=this._events)n.call(e,t)&&r.push(i?t.slice(1):t);return Object.getOwnPropertySymbols?r.concat(Object.getOwnPropertySymbols(e)):r},c.prototype.listeners=function(e){var t=i?i+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var n=0,s=r.length,o=new Array(s);n<s;n++)o[n]=r[n].fn;return o},c.prototype.listenerCount=function(e){var t=i?i+e:e,r=this._events[t];return r?r.fn?1:r.length:0},c.prototype.emit=function(e,t,r,n,s,o){var a=i?i+e:e;if(!this._events[a])return!1;var h,c,f=this._events[a],l=arguments.length;if(f.fn){switch(f.once&&this.removeListener(e,f.fn,void 0,!0),l){case 1:return f.fn.call(f.context),!0;case 2:return f.fn.call(f.context,t),!0;case 3:return f.fn.call(f.context,t,r),!0;case 4:return f.fn.call(f.context,t,r,n),!0;case 5:return f.fn.call(f.context,t,r,n,s),!0;case 6:return f.fn.call(f.context,t,r,n,s,o),!0}for(c=1,h=new Array(l-1);c<l;c++)h[c-1]=arguments[c];f.fn.apply(f.context,h)}else{var u,d=f.length;for(c=0;c<d;c++)switch(f[c].once&&this.removeListener(e,f[c].fn,void 0,!0),l){case 1:f[c].fn.call(f[c].context);break;case 2:f[c].fn.call(f[c].context,t);break;case 3:f[c].fn.call(f[c].context,t,r);break;case 4:f[c].fn.call(f[c].context,t,r,n);break;default:if(!h)for(u=1,h=new Array(l-1);u<l;u++)h[u-1]=arguments[u];f[c].fn.apply(f[c].context,h)}}return!0},c.prototype.on=function(e,t,r){return a(this,e,t,r,!1)},c.prototype.once=function(e,t,r){return a(this,e,t,r,!0)},c.prototype.removeListener=function(e,t,r,n){var s=i?i+e:e;if(!this._events[s])return this;if(!t)return h(this,s),this;var o=this._events[s];if(o.fn)o.fn!==t||n&&!o.once||r&&o.context!==r||h(this,s);else{for(var a=0,c=[],f=o.length;a<f;a++)(o[a].fn!==t||n&&!o[a].once||r&&o[a].context!==r)&&c.push(o[a]);c.length?this._events[s]=1===c.length?c[0]:c:h(this,s)}return this},c.prototype.removeAllListeners=function(e){var t;return e?(t=i?i+e:e,this._events[t]&&h(this,t)):(this._events=new s,this._eventsCount=0),this},c.prototype.off=c.prototype.removeListener,c.prototype.addListener=c.prototype.on,c.prefixed=i,c.EventEmitter=c,void 0!==t&&(t.exports=c)},{}]},{},[1])(1)}));let q={echo:0,loop:1,iam:2,svr:3,adm:4,auth:5,res:6,sub:7,sub1:8,pub:10,pub1:11,pub2:12};for(let e in q)q[q[e]]=e;const H=new TextEncoder,Y=new TextDecoder,J=R,X=P,K=D;class Z extends z{constructor(e,t=[]){super(),this.ws,this.lsid=Z.getID(),this.ssid=0,this.protocols=t,this.lastState=!1,this.maxPayload=1e3,this.serverURL=e,this.nick="",this.txCounter=0,this.rxCounter=0,this.lastTxRxTime=Date.now(),this.lastTxRxTimeOut=65e3,this.runCheckPeriod=3e3,this.runCheckIntervalID=null,this.isNode=!1,this.channels=new Set,this.promiseMap=new Map,this.promiseTimeOut=2e3,this.mid=0,"undefined"==typeof WebSocket&&(this.isNode=!0),Z.ls.add(this),this.connect()}static ls=new Set;static ID=1;static NodeWebSocket;static CMD=q;static getID(){return Z.ID++}static getByteSize(e){return m(e)}static timeStamp(){return p()}static buf2hex(e){return function(e){return Array.prototype.map.call(new Uint8Array(e),(e=>("00"+e.toString(16)).slice(-2))).join("")}(e)}static u8concat(...e){return V(...e)}static PU8(e){return W(e)}runChecker(e){if(1!=this.ws?.readyState)this.connect();else{Date.now()-this.lastTxRxTime>this.lastTxRxTimeOut&&this.echo()}}close(){this.ws?.close(1e3,"well done"),this.ws=null,clearInterval(this.runCheckIntervalID),this.runCheckIntervalID=null}open(e){this.connect(e)}connect(e){e&&(this.serverURL=e),this.runCheckIntervalID&&clearInterval(this.runCheckIntervalID),this.runCheckIntervalID=setInterval(this.runChecker.bind(this),this.runCheckPeriod),console.log("+"),this.ws?.close(),this.ws=null,this.isNode?(this.ws=new Z.NodeWebSocket(this.serverURL,this.protocols),this.ws.on("message",this.onWebSocketMessage.bind(this))):(this.ws=new WebSocket(this.serverURL,this.protocols),this.ws.addEventListener("message",this.onWebSocketMessage.bind(this))),this.ws.binaryType="arraybuffer",this.ws.onopen=e=>{this.subscribeChannelsToServer(),this.lastState||this.emit("statechange","open"),this.lastState=!0,this.emit("open","open")},this.ws.onerror=e=>{this.isNode&&console.log("e.error message",e.message)},this.ws.onclose=e=>{console.log("e.close  code,reason",e.code,e.reason),this.lastState&&this.emit("statechange","close"),this.lastState=!1,this.emit("close","close"),1009===e.code&&console.log("전송 크기 초과. Over maxPayload size")}}subscribeChannelsToServer(){if(this.channels.size>0){let e=Array.from(this.channels),t=H.encode(e.join(","));this.send(N.Buffer.concat([J("8",q.sub),J("16",++this.mid),J("16",t.byteLength),t]))}}onWebSocketMessage(e,t){let r;this.rxCounter++,this.lastTxRxTime=Date.now();let n=[];if(this.isNode?(r=e,t||(r=(new TextDecoder).decode(r))):(r=e.data,t=r instanceof ArrayBuffer),t)this.binaryMessageParser(N.Buffer.from(r));else try{let e=JSON.parse(r);if(Array.isArray(e))switch(n=e,console.log("("+n[0]+") "),n[0]){case"pub":n[1]&&n[2]&&(this.emit(n[0],...n),n.shift(),this.emit(n[0],...n));break;case"ssid":n[1]&&(this.ssid=n[1]);case"echo":case"iam":case"auth":this.emit(n[0],...n)}}catch(e){}this.emit("message",r,t)}binaryMessageParser(e){let t=e[0];switch(q[t],t){case q.res:let t=e.readUint8(1),r=e.readUint16BE(2),n=e.byteLength>4?e.subarray(4):"";console.log(`[RES] MID: ${r} CODE: ${t} `),this.testPromise(r,t,n);break;case q.pub:let i=j(e),s=Y.decode(i.chInfo),o=i.args;this.emit(s,s,...o);break;case q.svr:console.log(j(e).$);break;case q.pub1:if(e.byteLength>=6){let t=e.readUint16BE(2),r=e.readUint16BE(4);if(e.byteLength>=6+r){let n=e.slice(6,6+r),i=Y.decode(n);console.log("BIN_PUB1 chInfo",i);let s=e.slice(6+r);try{let e=Y.decode(s),t=JSON.parse(e);this.emit(i,i,...t)}catch(e){console.log("Invalid. PUB frame. mid:",t)}}}}}echoFrame(...e){e.length>0?(e.unshift("echo"),this.frame(...e)):this.frame("echo")}echo(...e){e.length>0?this.bin(q.echo,...e):this.bin(q.echo)}loop(...e){e.unshift("loop"),this.sendJSON(e)}frame(...e){this.sendJSON(e)}sendJSON(e){this.send(JSON.stringify(e))}send(e){1===this.ws?.readyState&&(this.txCounter++,this.lastTxRxTime=Date.now(),this.ws.send(e))}bin(...e){this.send(Z.u8concat(...e))}setMsgPromise(e){return new Promise(((t,r)=>{this.promiseMap.set(e,[t,r]),setTimeout((t=>{this.promiseMap.has(e)&&(r("timeout"),this.promiseMap.delete(e))}),this.promiseTimeOut)}))}testPromise(e,t,r){if(this.promiseMap.has(e)){console.log("res promise msg",e);let[n,i]=this.promiseMap.get(e);this.promiseMap.delete(e);let s=j(r);t<128?n(s):i(s)}}auth(...e){let t=++this.mid;return this.send(F(X("cmd","8",q.auth),X("mid","16",t),K(...e))),this.setMsgPromise(t)}publish(e,...t){let r=this.pub(e,...t);return this.setMsgPromise(r)}pub(e,...t){if("string"!=typeof e)throw"first parameter : channelName should be string.";let r=H.encode(e);return this.send(F(X("#cmd","8",q.pub),X("#mid","16",++this.mid),X("#chLen","16",r.byteLength),X("chInfo",r),K(...t))),this.mid}subscribe(e,t){let r=this.sub(e,t);return this.setMsgPromise(r)}sub(e,t){if("string"!=typeof e)throw"first parameter : channelName should be string.";let r=H.encode(e);return this.send(N.Buffer.concat([J("8",q.sub),J("16",++this.mid),J("16",r.byteLength),r])),this.channels.add(e),t&&this.on(e,t),this.mid}publishFrame(e,...t){this.frame("pub",e,...t)}subscribeFrame(e,t){this.channels.add(e),this.frame("sub",e),t&&this.on(e,t)}unsubscribeFrame(e){this.channels.delete(e),this.removeAllListeners(e)}}var Q={BINARY_TYPES:["nodebuffer","arraybuffer","fragments"],EMPTY_BUFFER:Buffer.alloc(0),GUID:"258EAFA5-E914-47DA-95CA-C5AB0DC85B11",kForOnEventAttribute:Symbol("kIsForOnEventAttribute"),kListener:Symbol("kListener"),kStatusCode:Symbol("status-code"),kWebSocket:Symbol("websocket"),NOOP:()=>{}},ee="function"==typeof __webpack_require__?__non_webpack_require__:y,te=process.config&&process.config.variables||{},re=!!process.env.PREBUILDS_ONLY,ne=process.versions.modules,ie=!(!process.versions||!process.versions.electron)||!!process.env.ELECTRON_RUN_AS_NODE||"undefined"!=typeof window&&window.process&&"renderer"===window.process.type?"electron":process.versions&&process.versions.nw?"node-webkit":"node",se=i.arch(),oe=i.platform(),ae=process.env.LIBC||(function(e){return"linux"===e&&r.existsSync("/etc/alpine-release")}(oe)?"musl":"glibc"),he=process.env.ARM_VERSION||("arm64"===se?"8":te.arm_version)||"",ce=(process.versions.uv||"").split(".")[0],fe=le;function le(e){return ee(le.path(e))}function ue(e){try{return r.readdirSync(e)}catch(e){return[]}}function de(e,t){var r=ue(e).filter(t);return r[0]&&n.join(e,r[0])}function pe(e){return/\.node$/.test(e)}function me(e){var t=e.split("-");if(2===t.length){var r=t[0],n=t[1].split("+");if(r&&n.length&&n.every(Boolean))return{name:e,platform:r,architectures:n}}}function ge(e,t){return function(r){return null!=r&&(r.platform===e&&r.architectures.includes(t))}}function ye(e,t){return e.architectures.length-t.architectures.length}function _e(e){var t=e.split("."),r={file:e,specificity:0};if("node"===t.pop()){for(var n=0;n<t.length;n++){var i=t[n];if("node"===i||"electron"===i||"node-webkit"===i)r.runtime=i;else if("napi"===i)r.napi=!0;else if("abi"===i.slice(0,3))r.abi=i.slice(3);else if("uv"===i.slice(0,2))r.uv=i.slice(2);else if("armv"===i.slice(0,4))r.armv=i.slice(4);else{if("glibc"!==i&&"musl"!==i)continue;r.libc=i}r.specificity++}return r}}function be(e,t){return function(r){return null!=r&&(!(r.runtime!==e&&!function(e){return"node"===e.runtime&&e.napi}(r))&&(!(r.abi!==t&&!r.napi)&&((!r.uv||r.uv===ce)&&((!r.armv||r.armv===he)&&(!r.libc||r.libc===ae)))))}}function we(e){return function(t,r){return t.runtime!==r.runtime?t.runtime===e?-1:1:t.abi!==r.abi?t.abi?-1:1:t.specificity!==r.specificity?t.specificity>r.specificity?-1:1:0}}le.path=function(e){e=n.resolve(e||".");try{var t=ee(n.join(e,"package.json")).name.toUpperCase().replace(/-/g,"_");process.env[t+"_PREBUILD"]&&(e=process.env[t+"_PREBUILD"])}catch(e){}if(!re){var r=de(n.join(e,"build/Release"),pe);if(r)return r;var i=de(n.join(e,"build/Debug"),pe);if(i)return i}var s=h(e);if(s)return s;var o=h(n.dirname(process.execPath));if(o)return o;var a=["platform="+oe,"arch="+se,"runtime="+ie,"abi="+ne,"uv="+ce,he?"armv="+he:"","libc="+ae,"node="+process.versions.node,process.versions.electron?"electron="+process.versions.electron:"","function"==typeof __webpack_require__?"webpack=true":""].filter(Boolean).join(" ");throw new Error("No native build was found for "+a+"\n    loaded from: "+e+"\n");function h(e){var t=ue(n.join(e,"prebuilds")).map(me).filter(ge(oe,se)).sort(ye)[0];if(t){var r=n.join(e,"prebuilds",t.name),i=ue(r).map(_e).filter(be(ie,ne)).sort(we(ie))[0];return i?n.join(r,i.file):void 0}}},le.parseTags=_e,le.matchTags=be,le.compareTags=we,le.parseTuple=me,le.matchTuple=ge,le.compareTuples=ye;var ve={mask:(e,t,r,n,i)=>{for(var s=0;s<i;s++)r[n+s]=e[s]^t[3&s]},unmask:(e,t)=>{const r=e.length;for(var n=0;n<r;n++)e[n]^=t[3&n]}},Ee=g((function(e){try{e.exports=fe(__dirname)}catch(t){e.exports=ve}})),Se=g((function(e){const{EMPTY_BUFFER:t}=Q;function r(e,r){if(0===e.length)return t;if(1===e.length)return e[0];const n=Buffer.allocUnsafe(r);let i=0;for(let t=0;t<e.length;t++){const r=e[t];n.set(r,i),i+=r.length}return i<r?n.slice(0,i):n}function n(e,t,r,n,i){for(let s=0;s<i;s++)r[n+s]=e[s]^t[3&s]}function i(e,t){for(let r=0;r<e.length;r++)e[r]^=t[3&r]}function s(e){return e.byteLength===e.buffer.byteLength?e.buffer:e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}function o(e){if(o.readOnly=!0,Buffer.isBuffer(e))return e;let t;return e instanceof ArrayBuffer?t=Buffer.from(e):ArrayBuffer.isView(e)?t=Buffer.from(e.buffer,e.byteOffset,e.byteLength):(t=Buffer.from(e),o.readOnly=!1),t}try{const t=Ee;e.exports={concat:r,mask(e,r,i,s,o){o<48?n(e,r,i,s,o):t.mask(e,r,i,s,o)},toArrayBuffer:s,toBuffer:o,unmask(e,r){e.length<32?i(e,r):t.unmask(e,r)}}}catch(t){e.exports={concat:r,mask:n,toArrayBuffer:s,toBuffer:o,unmask:i}}}));const xe=Symbol("kDone"),ke=Symbol("kRun");var Be=class{constructor(e){this[xe]=()=>{this.pending--,this[ke]()},this.concurrency=e||1/0,this.jobs=[],this.pending=0}add(e){this.jobs.push(e),this[ke]()}[ke](){if(this.pending!==this.concurrency&&this.jobs.length){const e=this.jobs.shift();this.pending++,e(this[xe])}}};const{kStatusCode:Oe}=Q,Le=Buffer.from([0,0,255,255]),Ie=Symbol("permessage-deflate"),Te=Symbol("total-length"),Ce=Symbol("callback"),Ne=Symbol("buffers"),Ue=Symbol("error");let Ae;var Re=class{constructor(e,t,r){if(this._maxPayload=0|r,this._options=e||{},this._threshold=void 0!==this._options.threshold?this._options.threshold:1024,this._isServer=!!t,this._deflate=null,this._inflate=null,this.params=null,!Ae){const e=void 0!==this._options.concurrencyLimit?this._options.concurrencyLimit:10;Ae=new Be(e)}}static get extensionName(){return"permessage-deflate"}offer(){const e={};return this._options.serverNoContextTakeover&&(e.server_no_context_takeover=!0),this._options.clientNoContextTakeover&&(e.client_no_context_takeover=!0),this._options.serverMaxWindowBits&&(e.server_max_window_bits=this._options.serverMaxWindowBits),this._options.clientMaxWindowBits?e.client_max_window_bits=this._options.clientMaxWindowBits:null==this._options.clientMaxWindowBits&&(e.client_max_window_bits=!0),e}accept(e){return e=this.normalizeParams(e),this.params=this._isServer?this.acceptAsServer(e):this.acceptAsClient(e),this.params}cleanup(){if(this._inflate&&(this._inflate.close(),this._inflate=null),this._deflate){const e=this._deflate[Ce];this._deflate.close(),this._deflate=null,e&&e(new Error("The deflate stream was closed while data was being processed"))}}acceptAsServer(e){const t=this._options,r=e.find((e=>!(!1===t.serverNoContextTakeover&&e.server_no_context_takeover||e.server_max_window_bits&&(!1===t.serverMaxWindowBits||"number"==typeof t.serverMaxWindowBits&&t.serverMaxWindowBits>e.server_max_window_bits)||"number"==typeof t.clientMaxWindowBits&&!e.client_max_window_bits)));if(!r)throw new Error("None of the extension offers can be accepted");return t.serverNoContextTakeover&&(r.server_no_context_takeover=!0),t.clientNoContextTakeover&&(r.client_no_context_takeover=!0),"number"==typeof t.serverMaxWindowBits&&(r.server_max_window_bits=t.serverMaxWindowBits),"number"==typeof t.clientMaxWindowBits?r.client_max_window_bits=t.clientMaxWindowBits:!0!==r.client_max_window_bits&&!1!==t.clientMaxWindowBits||delete r.client_max_window_bits,r}acceptAsClient(e){const t=e[0];if(!1===this._options.clientNoContextTakeover&&t.client_no_context_takeover)throw new Error('Unexpected parameter "client_no_context_takeover"');if(t.client_max_window_bits){if(!1===this._options.clientMaxWindowBits||"number"==typeof this._options.clientMaxWindowBits&&t.client_max_window_bits>this._options.clientMaxWindowBits)throw new Error('Unexpected or invalid parameter "client_max_window_bits"')}else"number"==typeof this._options.clientMaxWindowBits&&(t.client_max_window_bits=this._options.clientMaxWindowBits);return t}normalizeParams(e){return e.forEach((e=>{Object.keys(e).forEach((t=>{let r=e[t];if(r.length>1)throw new Error(`Parameter "${t}" must have only a single value`);if(r=r[0],"client_max_window_bits"===t){if(!0!==r){const e=+r;if(!Number.isInteger(e)||e<8||e>15)throw new TypeError(`Invalid value for parameter "${t}": ${r}`);r=e}else if(!this._isServer)throw new TypeError(`Invalid value for parameter "${t}": ${r}`)}else if("server_max_window_bits"===t){const e=+r;if(!Number.isInteger(e)||e<8||e>15)throw new TypeError(`Invalid value for parameter "${t}": ${r}`);r=e}else{if("client_no_context_takeover"!==t&&"server_no_context_takeover"!==t)throw new Error(`Unknown parameter "${t}"`);if(!0!==r)throw new TypeError(`Invalid value for parameter "${t}": ${r}`)}e[t]=r}))})),e}decompress(e,t,r){Ae.add((n=>{this._decompress(e,t,((e,t)=>{n(),r(e,t)}))}))}compress(e,t,r){Ae.add((n=>{this._compress(e,t,((e,t)=>{n(),r(e,t)}))}))}_decompress(e,r,n){const i=this._isServer?"client":"server";if(!this._inflate){const e=`${i}_max_window_bits`,r="number"!=typeof this.params[e]?t.Z_DEFAULT_WINDOWBITS:this.params[e];this._inflate=t.createInflateRaw({...this._options.zlibInflateOptions,windowBits:r}),this._inflate[Ie]=this,this._inflate[Te]=0,this._inflate[Ne]=[],this._inflate.on("error",De),this._inflate.on("data",Pe)}this._inflate[Ce]=n,this._inflate.write(e),r&&this._inflate.write(Le),this._inflate.flush((()=>{const e=this._inflate[Ue];if(e)return this._inflate.close(),this._inflate=null,void n(e);const t=Se.concat(this._inflate[Ne],this._inflate[Te]);this._inflate._readableState.endEmitted?(this._inflate.close(),this._inflate=null):(this._inflate[Te]=0,this._inflate[Ne]=[],r&&this.params[`${i}_no_context_takeover`]&&this._inflate.reset()),n(null,t)}))}_compress(e,r,n){const i=this._isServer?"server":"client";if(!this._deflate){const e=`${i}_max_window_bits`,r="number"!=typeof this.params[e]?t.Z_DEFAULT_WINDOWBITS:this.params[e];this._deflate=t.createDeflateRaw({...this._options.zlibDeflateOptions,windowBits:r}),this._deflate[Te]=0,this._deflate[Ne]=[],this._deflate.on("data",Me)}this._deflate[Ce]=n,this._deflate.write(e),this._deflate.flush(t.Z_SYNC_FLUSH,(()=>{if(!this._deflate)return;let e=Se.concat(this._deflate[Ne],this._deflate[Te]);r&&(e=e.slice(0,e.length-4)),this._deflate[Ce]=null,this._deflate[Te]=0,this._deflate[Ne]=[],r&&this.params[`${i}_no_context_takeover`]&&this._deflate.reset(),n(null,e)}))}};function Me(e){this[Ne].push(e),this[Te]+=e.length}function Pe(e){this[Te]+=e.length,this[Ie]._maxPayload<1||this[Te]<=this[Ie]._maxPayload?this[Ne].push(e):(this[Ue]=new RangeError("Max payload size exceeded"),this[Ue].code="WS_ERR_UNSUPPORTED_MESSAGE_LENGTH",this[Ue][Oe]=1009,this.removeListener("data",Pe),this.reset())}function De(e){this[Ie]._inflate=null,e[Oe]=1007,this[Ce](e)}var $e=function(e){const t=e.length;let r=0;for(;r<t;)if(0==(128&e[r]))r++;else if(192==(224&e[r])){if(r+1===t||128!=(192&e[r+1])||192==(254&e[r]))return!1;r+=2}else if(224==(240&e[r])){if(r+2>=t||128!=(192&e[r+1])||128!=(192&e[r+2])||224===e[r]&&128==(224&e[r+1])||237===e[r]&&160==(224&e[r+1]))return!1;r+=3}else{if(240!=(248&e[r]))return!1;if(r+3>=t||128!=(192&e[r+1])||128!=(192&e[r+2])||128!=(192&e[r+3])||240===e[r]&&128==(240&e[r+1])||244===e[r]&&e[r+1]>143||e[r]>244)return!1;r+=4}return!0},Fe=g((function(e){try{e.exports=fe(__dirname)}catch(t){e.exports=$e}})),je=g((function(e){const t=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0];function r(e){return e>=1e3&&e<=1014&&1004!==e&&1005!==e&&1006!==e||e>=3e3&&e<=4999}function n(e){const t=e.length;let r=0;for(;r<t;)if(0==(128&e[r]))r++;else if(192==(224&e[r])){if(r+1===t||128!=(192&e[r+1])||192==(254&e[r]))return!1;r+=2}else if(224==(240&e[r])){if(r+2>=t||128!=(192&e[r+1])||128!=(192&e[r+2])||224===e[r]&&128==(224&e[r+1])||237===e[r]&&160==(224&e[r+1]))return!1;r+=3}else{if(240!=(248&e[r]))return!1;if(r+3>=t||128!=(192&e[r+1])||128!=(192&e[r+2])||128!=(192&e[r+3])||240===e[r]&&128==(240&e[r+1])||244===e[r]&&e[r+1]>143||e[r]>244)return!1;r+=4}return!0}try{const i=Fe;e.exports={isValidStatusCode:r,isValidUTF8:e=>e.length<150?n(e):i(e),tokenChars:t}}catch(i){e.exports={isValidStatusCode:r,isValidUTF8:n,tokenChars:t}}}));const{Writable:We}=e,{BINARY_TYPES:Ge,EMPTY_BUFFER:Ve,kStatusCode:ze,kWebSocket:qe}=Q,{concat:He,toArrayBuffer:Ye,unmask:Je}=Se,{isValidStatusCode:Xe,isValidUTF8:Ke}=je;var Ze=class extends We{constructor(e={}){super(),this._binaryType=e.binaryType||Ge[0],this._extensions=e.extensions||{},this._isServer=!!e.isServer,this._maxPayload=0|e.maxPayload,this._skipUTF8Validation=!!e.skipUTF8Validation,this[qe]=void 0,this._bufferedBytes=0,this._buffers=[],this._compressed=!1,this._payloadLength=0,this._mask=void 0,this._fragmented=0,this._masked=!1,this._fin=!1,this._opcode=0,this._totalPayloadLength=0,this._messageLength=0,this._fragments=[],this._state=0,this._loop=!1}_write(e,t,r){if(8===this._opcode&&0==this._state)return r();this._bufferedBytes+=e.length,this._buffers.push(e),this.startLoop(r)}consume(e){if(this._bufferedBytes-=e,e===this._buffers[0].length)return this._buffers.shift();if(e<this._buffers[0].length){const t=this._buffers[0];return this._buffers[0]=t.slice(e),t.slice(0,e)}const t=Buffer.allocUnsafe(e);do{const r=this._buffers[0],n=t.length-e;e>=r.length?t.set(this._buffers.shift(),n):(t.set(new Uint8Array(r.buffer,r.byteOffset,e),n),this._buffers[0]=r.slice(e)),e-=r.length}while(e>0);return t}startLoop(e){let t;this._loop=!0;do{switch(this._state){case 0:t=this.getInfo();break;case 1:t=this.getPayloadLength16();break;case 2:t=this.getPayloadLength64();break;case 3:this.getMask();break;case 4:t=this.getData(e);break;default:return void(this._loop=!1)}}while(this._loop);e(t)}getInfo(){if(this._bufferedBytes<2)return void(this._loop=!1);const e=this.consume(2);if(0!=(48&e[0]))return this._loop=!1,Qe(RangeError,"RSV2 and RSV3 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_2_3");const t=64==(64&e[0]);if(t&&!this._extensions[Re.extensionName])return this._loop=!1,Qe(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");if(this._fin=128==(128&e[0]),this._opcode=15&e[0],this._payloadLength=127&e[1],0===this._opcode){if(t)return this._loop=!1,Qe(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");if(!this._fragmented)return this._loop=!1,Qe(RangeError,"invalid opcode 0",!0,1002,"WS_ERR_INVALID_OPCODE");this._opcode=this._fragmented}else if(1===this._opcode||2===this._opcode){if(this._fragmented)return this._loop=!1,Qe(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE");this._compressed=t}else{if(!(this._opcode>7&&this._opcode<11))return this._loop=!1,Qe(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE");if(!this._fin)return this._loop=!1,Qe(RangeError,"FIN must be set",!0,1002,"WS_ERR_EXPECTED_FIN");if(t)return this._loop=!1,Qe(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");if(this._payloadLength>125)return this._loop=!1,Qe(RangeError,`invalid payload length ${this._payloadLength}`,!0,1002,"WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH")}if(this._fin||this._fragmented||(this._fragmented=this._opcode),this._masked=128==(128&e[1]),this._isServer){if(!this._masked)return this._loop=!1,Qe(RangeError,"MASK must be set",!0,1002,"WS_ERR_EXPECTED_MASK")}else if(this._masked)return this._loop=!1,Qe(RangeError,"MASK must be clear",!0,1002,"WS_ERR_UNEXPECTED_MASK");if(126===this._payloadLength)this._state=1;else{if(127!==this._payloadLength)return this.haveLength();this._state=2}}getPayloadLength16(){if(!(this._bufferedBytes<2))return this._payloadLength=this.consume(2).readUInt16BE(0),this.haveLength();this._loop=!1}getPayloadLength64(){if(this._bufferedBytes<8)return void(this._loop=!1);const e=this.consume(8),t=e.readUInt32BE(0);return t>Math.pow(2,21)-1?(this._loop=!1,Qe(RangeError,"Unsupported WebSocket frame: payload length > 2^53 - 1",!1,1009,"WS_ERR_UNSUPPORTED_DATA_PAYLOAD_LENGTH")):(this._payloadLength=t*Math.pow(2,32)+e.readUInt32BE(4),this.haveLength())}haveLength(){if(this._payloadLength&&this._opcode<8&&(this._totalPayloadLength+=this._payloadLength,this._totalPayloadLength>this._maxPayload&&this._maxPayload>0))return this._loop=!1,Qe(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH");this._masked?this._state=3:this._state=4}getMask(){this._bufferedBytes<4?this._loop=!1:(this._mask=this.consume(4),this._state=4)}getData(e){let t=Ve;if(this._payloadLength){if(this._bufferedBytes<this._payloadLength)return void(this._loop=!1);t=this.consume(this._payloadLength),this._masked&&0!=(this._mask[0]|this._mask[1]|this._mask[2]|this._mask[3])&&Je(t,this._mask)}return this._opcode>7?this.controlMessage(t):this._compressed?(this._state=5,void this.decompress(t,e)):(t.length&&(this._messageLength=this._totalPayloadLength,this._fragments.push(t)),this.dataMessage())}decompress(e,t){this._extensions[Re.extensionName].decompress(e,this._fin,((e,r)=>{if(e)return t(e);if(r.length){if(this._messageLength+=r.length,this._messageLength>this._maxPayload&&this._maxPayload>0)return t(Qe(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH"));this._fragments.push(r)}const n=this.dataMessage();if(n)return t(n);this.startLoop(t)}))}dataMessage(){if(this._fin){const e=this._messageLength,t=this._fragments;if(this._totalPayloadLength=0,this._messageLength=0,this._fragmented=0,this._fragments=[],2===this._opcode){let r;r="nodebuffer"===this._binaryType?He(t,e):"arraybuffer"===this._binaryType?Ye(He(t,e)):t,this.emit("message",r,!0)}else{const r=He(t,e);if(!this._skipUTF8Validation&&!Ke(r))return this._loop=!1,Qe(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");this.emit("message",r,!1)}}this._state=0}controlMessage(e){if(8===this._opcode)if(this._loop=!1,0===e.length)this.emit("conclude",1005,Ve),this.end();else{if(1===e.length)return Qe(RangeError,"invalid payload length 1",!0,1002,"WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH");{const t=e.readUInt16BE(0);if(!Xe(t))return Qe(RangeError,`invalid status code ${t}`,!0,1002,"WS_ERR_INVALID_CLOSE_CODE");const r=e.slice(2);if(!this._skipUTF8Validation&&!Ke(r))return Qe(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");this.emit("conclude",t,r),this.end()}}else 9===this._opcode?this.emit("ping",e):this.emit("pong",e);this._state=0}};function Qe(e,t,r,n,i){const s=new e(r?`Invalid WebSocket frame: ${t}`:t);return Error.captureStackTrace(s,Qe),s.code=i,s[ze]=n,s}const{randomFillSync:et}=a,{EMPTY_BUFFER:tt}=Q,{isValidStatusCode:rt}=je,{mask:nt,toBuffer:it}=Se,st=Symbol("kByteLength"),ot=Buffer.alloc(4);class at{constructor(e,t,r){this._extensions=t||{},r&&(this._generateMask=r,this._maskBuffer=Buffer.alloc(4)),this._socket=e,this._firstFragment=!0,this._compress=!1,this._bufferedBytes=0,this._deflating=!1,this._queue=[]}static frame(e,t){let r,n,i=!1,s=2,o=!1;t.mask&&(r=t.maskBuffer||ot,t.generateMask?t.generateMask(r):et(r,0,4),o=0==(r[0]|r[1]|r[2]|r[3]),s=6),"string"==typeof e?n=t.mask&&!o||void 0===t[st]?(e=Buffer.from(e)).length:t[st]:(n=e.length,i=t.mask&&t.readOnly&&!o);let a=n;n>=65536?(s+=8,a=127):n>125&&(s+=2,a=126);const h=Buffer.allocUnsafe(i?n+s:s);return h[0]=t.fin?128|t.opcode:t.opcode,t.rsv1&&(h[0]|=64),h[1]=a,126===a?h.writeUInt16BE(n,2):127===a&&(h[2]=h[3]=0,h.writeUIntBE(n,4,6)),t.mask?(h[1]|=128,h[s-4]=r[0],h[s-3]=r[1],h[s-2]=r[2],h[s-1]=r[3],o?[h,e]:i?(nt(e,r,h,s,n),[h]):(nt(e,r,e,0,n),[h,e])):[h,e]}close(e,t,r,n){let i;if(void 0===e)i=tt;else{if("number"!=typeof e||!rt(e))throw new TypeError("First argument must be a valid error code number");if(void 0!==t&&t.length){const r=Buffer.byteLength(t);if(r>123)throw new RangeError("The message must not be greater than 123 bytes");i=Buffer.allocUnsafe(2+r),i.writeUInt16BE(e,0),"string"==typeof t?i.write(t,2):i.set(t,2)}else i=Buffer.allocUnsafe(2),i.writeUInt16BE(e,0)}const s={[st]:i.length,fin:!0,generateMask:this._generateMask,mask:r,maskBuffer:this._maskBuffer,opcode:8,readOnly:!1,rsv1:!1};this._deflating?this.enqueue([this.dispatch,i,!1,s,n]):this.sendFrame(at.frame(i,s),n)}ping(e,t,r){let n,i;if("string"==typeof e?(n=Buffer.byteLength(e),i=!1):(n=(e=it(e)).length,i=it.readOnly),n>125)throw new RangeError("The data size must not be greater than 125 bytes");const s={[st]:n,fin:!0,generateMask:this._generateMask,mask:t,maskBuffer:this._maskBuffer,opcode:9,readOnly:i,rsv1:!1};this._deflating?this.enqueue([this.dispatch,e,!1,s,r]):this.sendFrame(at.frame(e,s),r)}pong(e,t,r){let n,i;if("string"==typeof e?(n=Buffer.byteLength(e),i=!1):(n=(e=it(e)).length,i=it.readOnly),n>125)throw new RangeError("The data size must not be greater than 125 bytes");const s={[st]:n,fin:!0,generateMask:this._generateMask,mask:t,maskBuffer:this._maskBuffer,opcode:10,readOnly:i,rsv1:!1};this._deflating?this.enqueue([this.dispatch,e,!1,s,r]):this.sendFrame(at.frame(e,s),r)}send(e,t,r){const n=this._extensions[Re.extensionName];let i,s,o=t.binary?2:1,a=t.compress;if("string"==typeof e?(i=Buffer.byteLength(e),s=!1):(i=(e=it(e)).length,s=it.readOnly),this._firstFragment?(this._firstFragment=!1,a&&n&&n.params[n._isServer?"server_no_context_takeover":"client_no_context_takeover"]&&(a=i>=n._threshold),this._compress=a):(a=!1,o=0),t.fin&&(this._firstFragment=!0),n){const n={[st]:i,fin:t.fin,generateMask:this._generateMask,mask:t.mask,maskBuffer:this._maskBuffer,opcode:o,readOnly:s,rsv1:a};this._deflating?this.enqueue([this.dispatch,e,this._compress,n,r]):this.dispatch(e,this._compress,n,r)}else this.sendFrame(at.frame(e,{[st]:i,fin:t.fin,generateMask:this._generateMask,mask:t.mask,maskBuffer:this._maskBuffer,opcode:o,readOnly:s,rsv1:!1}),r)}dispatch(e,t,r,n){if(!t)return void this.sendFrame(at.frame(e,r),n);const i=this._extensions[Re.extensionName];this._bufferedBytes+=r[st],this._deflating=!0,i.compress(e,r.fin,((e,t)=>{if(this._socket.destroyed){const e=new Error("The socket was closed while data was being compressed");"function"==typeof n&&n(e);for(let t=0;t<this._queue.length;t++){const r=this._queue[t],n=r[r.length-1];"function"==typeof n&&n(e)}}else this._bufferedBytes-=r[st],this._deflating=!1,r.readOnly=!1,this.sendFrame(at.frame(t,r),n),this.dequeue()}))}dequeue(){for(;!this._deflating&&this._queue.length;){const e=this._queue.shift();this._bufferedBytes-=e[3][st],Reflect.apply(e[0],this,e.slice(1))}}enqueue(e){this._bufferedBytes+=e[3][st],this._queue.push(e)}sendFrame(e,t){2===e.length?(this._socket.cork(),this._socket.write(e[0]),this._socket.write(e[1],t),this._socket.uncork()):this._socket.write(e[0],t)}}var ht=at;const{kForOnEventAttribute:ct,kListener:ft}=Q,lt=Symbol("kCode"),ut=Symbol("kData"),dt=Symbol("kError"),pt=Symbol("kMessage"),mt=Symbol("kReason"),gt=Symbol("kTarget"),yt=Symbol("kType"),_t=Symbol("kWasClean");class bt{constructor(e){this[gt]=null,this[yt]=e}get target(){return this[gt]}get type(){return this[yt]}}Object.defineProperty(bt.prototype,"target",{enumerable:!0}),Object.defineProperty(bt.prototype,"type",{enumerable:!0});class wt extends bt{constructor(e,t={}){super(e),this[lt]=void 0===t.code?0:t.code,this[mt]=void 0===t.reason?"":t.reason,this[_t]=void 0!==t.wasClean&&t.wasClean}get code(){return this[lt]}get reason(){return this[mt]}get wasClean(){return this[_t]}}Object.defineProperty(wt.prototype,"code",{enumerable:!0}),Object.defineProperty(wt.prototype,"reason",{enumerable:!0}),Object.defineProperty(wt.prototype,"wasClean",{enumerable:!0});class vt extends bt{constructor(e,t={}){super(e),this[dt]=void 0===t.error?null:t.error,this[pt]=void 0===t.message?"":t.message}get error(){return this[dt]}get message(){return this[pt]}}Object.defineProperty(vt.prototype,"error",{enumerable:!0}),Object.defineProperty(vt.prototype,"message",{enumerable:!0});class Et extends bt{constructor(e,t={}){super(e),this[ut]=void 0===t.data?null:t.data}get data(){return this[ut]}}Object.defineProperty(Et.prototype,"data",{enumerable:!0});const St={addEventListener(e,t,r={}){let n;if("message"===e)n=function(e,r){const n=new Et("message",{data:r?e:e.toString()});n[gt]=this,t.call(this,n)};else if("close"===e)n=function(e,r){const n=new wt("close",{code:e,reason:r.toString(),wasClean:this._closeFrameReceived&&this._closeFrameSent});n[gt]=this,t.call(this,n)};else if("error"===e)n=function(e){const r=new vt("error",{error:e,message:e.message});r[gt]=this,t.call(this,r)};else{if("open"!==e)return;n=function(){const e=new bt("open");e[gt]=this,t.call(this,e)}}n[ct]=!!r[ct],n[ft]=t,r.once?this.once(e,n):this.on(e,n)},removeEventListener(e,t){for(const r of this.listeners(e))if(r[ft]===t&&!r[ct]){this.removeListener(e,r);break}}};var xt={CloseEvent:wt,ErrorEvent:vt,Event:bt,EventTarget:St,MessageEvent:Et};const{tokenChars:kt}=je;function Bt(e,t,r){void 0===e[t]?e[t]=[r]:e[t].push(r)}var Ot={format:function(e){return Object.keys(e).map((t=>{let r=e[t];return Array.isArray(r)||(r=[r]),r.map((e=>[t].concat(Object.keys(e).map((t=>{let r=e[t];return Array.isArray(r)||(r=[r]),r.map((e=>!0===e?t:`${t}=${e}`)).join("; ")}))).join("; "))).join(", ")})).join(", ")},parse:function(e){const t=Object.create(null);let r,n,i=Object.create(null),s=!1,o=!1,a=!1,h=-1,c=-1,f=-1,l=0;for(;l<e.length;l++)if(c=e.charCodeAt(l),void 0===r)if(-1===f&&1===kt[c])-1===h&&(h=l);else if(0===l||32!==c&&9!==c){if(59!==c&&44!==c)throw new SyntaxError(`Unexpected character at index ${l}`);{if(-1===h)throw new SyntaxError(`Unexpected character at index ${l}`);-1===f&&(f=l);const n=e.slice(h,f);44===c?(Bt(t,n,i),i=Object.create(null)):r=n,h=f=-1}}else-1===f&&-1!==h&&(f=l);else if(void 0===n)if(-1===f&&1===kt[c])-1===h&&(h=l);else if(32===c||9===c)-1===f&&-1!==h&&(f=l);else if(59===c||44===c){if(-1===h)throw new SyntaxError(`Unexpected character at index ${l}`);-1===f&&(f=l),Bt(i,e.slice(h,f),!0),44===c&&(Bt(t,r,i),i=Object.create(null),r=void 0),h=f=-1}else{if(61!==c||-1===h||-1!==f)throw new SyntaxError(`Unexpected character at index ${l}`);n=e.slice(h,l),h=f=-1}else if(o){if(1!==kt[c])throw new SyntaxError(`Unexpected character at index ${l}`);-1===h?h=l:s||(s=!0),o=!1}else if(a)if(1===kt[c])-1===h&&(h=l);else if(34===c&&-1!==h)a=!1,f=l;else{if(92!==c)throw new SyntaxError(`Unexpected character at index ${l}`);o=!0}else if(34===c&&61===e.charCodeAt(l-1))a=!0;else if(-1===f&&1===kt[c])-1===h&&(h=l);else if(-1===h||32!==c&&9!==c){if(59!==c&&44!==c)throw new SyntaxError(`Unexpected character at index ${l}`);{if(-1===h)throw new SyntaxError(`Unexpected character at index ${l}`);-1===f&&(f=l);let o=e.slice(h,f);s&&(o=o.replace(/\\/g,""),s=!1),Bt(i,n,o),44===c&&(Bt(t,r,i),i=Object.create(null),r=void 0),n=void 0,h=f=-1}}else-1===f&&(f=l);if(-1===h||a||32===c||9===c)throw new SyntaxError("Unexpected end of input");-1===f&&(f=l);const u=e.slice(h,f);return void 0===r?Bt(t,u,i):(void 0===n?Bt(i,u,!0):Bt(i,n,s?u.replace(/\\/g,""):u),Bt(t,r,i)),t}};const{randomBytes:Lt,createHash:It}=a,{URL:Tt}=u,{BINARY_TYPES:Ct,EMPTY_BUFFER:Nt,GUID:Ut,kForOnEventAttribute:At,kListener:Rt,kStatusCode:Mt,kWebSocket:Pt,NOOP:Dt}=Q,{EventTarget:{addEventListener:$t,removeEventListener:Ft}}=xt,{format:jt,parse:Wt}=Ot,{toBuffer:Gt}=Se,Vt=Symbol("kAborted"),zt=[8,13],qt=["CONNECTING","OPEN","CLOSING","CLOSED"],Ht=/^[!#$%&'*+\-.0-9A-Z^_`|a-z~]+$/;class Yt extends c{constructor(e,t,r){super(),this._binaryType=Ct[0],this._closeCode=1006,this._closeFrameReceived=!1,this._closeFrameSent=!1,this._closeMessage=Nt,this._closeTimer=null,this._extensions={},this._paused=!1,this._protocol="",this._readyState=Yt.CONNECTING,this._receiver=null,this._sender=null,this._socket=null,null!==e?(this._bufferedAmount=0,this._isServer=!1,this._redirects=0,void 0===t?t=[]:Array.isArray(t)||("object"==typeof t&&null!==t?(r=t,t=[]):t=[t]),Xt(this,e,t,r)):this._isServer=!0}get binaryType(){return this._binaryType}set binaryType(e){Ct.includes(e)&&(this._binaryType=e,this._receiver&&(this._receiver._binaryType=e))}get bufferedAmount(){return this._socket?this._socket._writableState.length+this._sender._bufferedBytes:this._bufferedAmount}get extensions(){return Object.keys(this._extensions).join()}get isPaused(){return this._paused}get onclose(){return null}get onerror(){return null}get onopen(){return null}get onmessage(){return null}get protocol(){return this._protocol}get readyState(){return this._readyState}get url(){return this._url}setSocket(e,t,r){const n=new Ze({binaryType:this.binaryType,extensions:this._extensions,isServer:this._isServer,maxPayload:r.maxPayload,skipUTF8Validation:r.skipUTF8Validation});this._sender=new ht(e,this._extensions,r.generateMask),this._receiver=n,this._socket=e,n[Pt]=this,e[Pt]=this,n.on("conclude",rr),n.on("drain",nr),n.on("error",ir),n.on("message",or),n.on("ping",ar),n.on("pong",hr),e.setTimeout(0),e.setNoDelay(),t.length>0&&e.unshift(t),e.on("close",fr),e.on("data",lr),e.on("end",ur),e.on("error",dr),this._readyState=Yt.OPEN,this.emit("open")}emitClose(){if(!this._socket)return this._readyState=Yt.CLOSED,void this.emit("close",this._closeCode,this._closeMessage);this._extensions[Re.extensionName]&&this._extensions[Re.extensionName].cleanup(),this._receiver.removeAllListeners(),this._readyState=Yt.CLOSED,this.emit("close",this._closeCode,this._closeMessage)}close(e,t){if(this.readyState!==Yt.CLOSED){if(this.readyState===Yt.CONNECTING){const e="WebSocket was closed before the connection was established";return er(this,this._req,e)}this.readyState!==Yt.CLOSING?(this._readyState=Yt.CLOSING,this._sender.close(e,t,!this._isServer,(e=>{e||(this._closeFrameSent=!0,(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end())})),this._closeTimer=setTimeout(this._socket.destroy.bind(this._socket),3e4)):this._closeFrameSent&&(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end()}}pause(){this.readyState!==Yt.CONNECTING&&this.readyState!==Yt.CLOSED&&(this._paused=!0,this._socket.pause())}ping(e,t,r){if(this.readyState===Yt.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");"function"==typeof e?(r=e,e=t=void 0):"function"==typeof t&&(r=t,t=void 0),"number"==typeof e&&(e=e.toString()),this.readyState===Yt.OPEN?(void 0===t&&(t=!this._isServer),this._sender.ping(e||Nt,t,r)):tr(this,e,r)}pong(e,t,r){if(this.readyState===Yt.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");"function"==typeof e?(r=e,e=t=void 0):"function"==typeof t&&(r=t,t=void 0),"number"==typeof e&&(e=e.toString()),this.readyState===Yt.OPEN?(void 0===t&&(t=!this._isServer),this._sender.pong(e||Nt,t,r)):tr(this,e,r)}resume(){this.readyState!==Yt.CONNECTING&&this.readyState!==Yt.CLOSED&&(this._paused=!1,this._receiver._writableState.needDrain||this._socket.resume())}send(e,t,r){if(this.readyState===Yt.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if("function"==typeof t&&(r=t,t={}),"number"==typeof e&&(e=e.toString()),this.readyState!==Yt.OPEN)return void tr(this,e,r);const n={binary:"string"!=typeof e,mask:!this._isServer,compress:!0,fin:!0,...t};this._extensions[Re.extensionName]||(n.compress=!1),this._sender.send(e||Nt,n,r)}terminate(){if(this.readyState!==Yt.CLOSED){if(this.readyState===Yt.CONNECTING){const e="WebSocket was closed before the connection was established";return er(this,this._req,e)}this._socket&&(this._readyState=Yt.CLOSING,this._socket.destroy())}}}Object.defineProperty(Yt,"CONNECTING",{enumerable:!0,value:qt.indexOf("CONNECTING")}),Object.defineProperty(Yt.prototype,"CONNECTING",{enumerable:!0,value:qt.indexOf("CONNECTING")}),Object.defineProperty(Yt,"OPEN",{enumerable:!0,value:qt.indexOf("OPEN")}),Object.defineProperty(Yt.prototype,"OPEN",{enumerable:!0,value:qt.indexOf("OPEN")}),Object.defineProperty(Yt,"CLOSING",{enumerable:!0,value:qt.indexOf("CLOSING")}),Object.defineProperty(Yt.prototype,"CLOSING",{enumerable:!0,value:qt.indexOf("CLOSING")}),Object.defineProperty(Yt,"CLOSED",{enumerable:!0,value:qt.indexOf("CLOSED")}),Object.defineProperty(Yt.prototype,"CLOSED",{enumerable:!0,value:qt.indexOf("CLOSED")}),["binaryType","bufferedAmount","extensions","isPaused","protocol","readyState","url"].forEach((e=>{Object.defineProperty(Yt.prototype,e,{enumerable:!0})})),["open","error","close","message"].forEach((e=>{Object.defineProperty(Yt.prototype,`on${e}`,{enumerable:!0,get(){for(const t of this.listeners(e))if(t[At])return t[Rt];return null},set(t){for(const t of this.listeners(e))if(t[At]){this.removeListener(e,t);break}"function"==typeof t&&this.addEventListener(e,t,{[At]:!0})}})})),Yt.prototype.addEventListener=$t,Yt.prototype.removeEventListener=Ft;var Jt=Yt;function Xt(e,t,r,n){const i={protocolVersion:zt[1],maxPayload:104857600,skipUTF8Validation:!1,perMessageDeflate:!0,followRedirects:!1,maxRedirects:10,...n,createConnection:void 0,socketPath:void 0,hostname:void 0,protocol:void 0,timeout:void 0,method:"GET",host:void 0,path:void 0,port:void 0};if(!zt.includes(i.protocolVersion))throw new RangeError(`Unsupported protocol version: ${i.protocolVersion} (supported versions: ${zt.join(", ")})`);let s;if(t instanceof Tt)s=t,e._url=t.href;else{try{s=new Tt(t)}catch(e){throw new SyntaxError(`Invalid URL: ${t}`)}e._url=t}const o="wss:"===s.protocol,a="ws+unix:"===s.protocol;let h;if("ws:"===s.protocol||o||a?a&&!s.pathname?h="The URL's pathname is empty":s.hash&&(h="The URL contains a fragment identifier"):h='The URL\'s protocol must be one of "ws:", "wss:", or "ws+unix:"',h){const t=new SyntaxError(h);if(0===e._redirects)throw t;return void Kt(e,t)}const c=o?443:80,u=Lt(16).toString("base64"),d=o?f.request:l.request,p=new Set;let m,g;if(i.createConnection=o?Qt:Zt,i.defaultPort=i.defaultPort||c,i.port=s.port||c,i.host=s.hostname.startsWith("[")?s.hostname.slice(1,-1):s.hostname,i.headers={"Sec-WebSocket-Version":i.protocolVersion,"Sec-WebSocket-Key":u,Connection:"Upgrade",Upgrade:"websocket",...i.headers},i.path=s.pathname+s.search,i.timeout=i.handshakeTimeout,i.perMessageDeflate&&(m=new Re(!0!==i.perMessageDeflate?i.perMessageDeflate:{},!1,i.maxPayload),i.headers["Sec-WebSocket-Extensions"]=jt({[Re.extensionName]:m.offer()})),r.length){for(const e of r){if("string"!=typeof e||!Ht.test(e)||p.has(e))throw new SyntaxError("An invalid or duplicated subprotocol was specified");p.add(e)}i.headers["Sec-WebSocket-Protocol"]=r.join(",")}if(i.origin&&(i.protocolVersion<13?i.headers["Sec-WebSocket-Origin"]=i.origin:i.headers.Origin=i.origin),(s.username||s.password)&&(i.auth=`${s.username}:${s.password}`),a){const e=i.path.split(":");i.socketPath=e[0],i.path=e[1]}if(i.followRedirects){if(0===e._redirects){e._originalHost=s.host;const t=n&&n.headers;if(n={...n,headers:{}},t)for(const[e,r]of Object.entries(t))n.headers[e.toLowerCase()]=r}else 0===e.listenerCount("redirect")&&s.host!==e._originalHost&&(delete i.headers.authorization,delete i.headers.cookie,delete i.headers.host,i.auth=void 0);i.auth&&!n.headers.authorization&&(n.headers.authorization="Basic "+Buffer.from(i.auth).toString("base64")),g=e._req=d(i),e._redirects&&e.emit("redirect",e.url,g)}else g=e._req=d(i);i.timeout&&g.on("timeout",(()=>{er(e,g,"Opening handshake has timed out")})),g.on("error",(t=>{null===g||g[Vt]||(g=e._req=null,Kt(e,t))})),g.on("response",(s=>{const o=s.headers.location,a=s.statusCode;if(o&&i.followRedirects&&a>=300&&a<400){if(++e._redirects>i.maxRedirects)return void er(e,g,"Maximum redirects exceeded");let s;g.abort();try{s=new Tt(o,t)}catch(t){const r=new SyntaxError(`Invalid URL: ${o}`);return void Kt(e,r)}Xt(e,s,r,n)}else e.emit("unexpected-response",g,s)||er(e,g,`Unexpected server response: ${s.statusCode}`)})),g.on("upgrade",((t,r,n)=>{if(e.emit("upgrade",t),e.readyState!==Yt.CONNECTING)return;g=e._req=null;const s=It("sha1").update(u+Ut).digest("base64");if(t.headers["sec-websocket-accept"]!==s)return void er(e,r,"Invalid Sec-WebSocket-Accept header");const o=t.headers["sec-websocket-protocol"];let a;if(void 0!==o?p.size?p.has(o)||(a="Server sent an invalid subprotocol"):a="Server sent a subprotocol but none was requested":p.size&&(a="Server sent no subprotocol"),a)return void er(e,r,a);o&&(e._protocol=o);const h=t.headers["sec-websocket-extensions"];if(void 0!==h){if(!m){return void er(e,r,"Server sent a Sec-WebSocket-Extensions header but no extension was requested")}let t;try{t=Wt(h)}catch(t){return void er(e,r,"Invalid Sec-WebSocket-Extensions header")}const n=Object.keys(t);if(1!==n.length||n[0]!==Re.extensionName){return void er(e,r,"Server indicated an extension that was not requested")}try{m.accept(t[Re.extensionName])}catch(t){return void er(e,r,"Invalid Sec-WebSocket-Extensions header")}e._extensions[Re.extensionName]=m}e.setSocket(r,n,{generateMask:i.generateMask,maxPayload:i.maxPayload,skipUTF8Validation:i.skipUTF8Validation})})),g.end()}function Kt(e,t){e._readyState=Yt.CLOSING,e.emit("error",t),e.emitClose()}function Zt(e){return e.path=e.socketPath,s.connect(e)}function Qt(e){return e.path=void 0,e.servername||""===e.servername||(e.servername=s.isIP(e.host)?"":e.host),o.connect(e)}function er(e,t,r){e._readyState=Yt.CLOSING;const n=new Error(r);Error.captureStackTrace(n,er),t.setHeader?(t[Vt]=!0,t.abort(),t.socket&&!t.socket.destroyed&&t.socket.destroy(),process.nextTick(Kt,e,n)):(t.destroy(n),t.once("error",e.emit.bind(e,"error")),t.once("close",e.emitClose.bind(e)))}function tr(e,t,r){if(t){const r=Gt(t).length;e._socket?e._sender._bufferedBytes+=r:e._bufferedAmount+=r}if(r){r(new Error(`WebSocket is not open: readyState ${e.readyState} (${qt[e.readyState]})`))}}function rr(e,t){const r=this[Pt];r._closeFrameReceived=!0,r._closeMessage=t,r._closeCode=e,void 0!==r._socket[Pt]&&(r._socket.removeListener("data",lr),process.nextTick(cr,r._socket),1005===e?r.close():r.close(e,t))}function nr(){const e=this[Pt];e.isPaused||e._socket.resume()}function ir(e){const t=this[Pt];void 0!==t._socket[Pt]&&(t._socket.removeListener("data",lr),process.nextTick(cr,t._socket),t.close(e[Mt])),t.emit("error",e)}function sr(){this[Pt].emitClose()}function or(e,t){this[Pt].emit("message",e,t)}function ar(e){const t=this[Pt];t.pong(e,!t._isServer,Dt),t.emit("ping",e)}function hr(e){this[Pt].emit("pong",e)}function cr(e){e.resume()}function fr(){const e=this[Pt];let t;this.removeListener("close",fr),this.removeListener("data",lr),this.removeListener("end",ur),e._readyState=Yt.CLOSING,this._readableState.endEmitted||e._closeFrameReceived||e._receiver._writableState.errorEmitted||null===(t=e._socket.read())||e._receiver.write(t),e._receiver.end(),this[Pt]=void 0,clearTimeout(e._closeTimer),e._receiver._writableState.finished||e._receiver._writableState.errorEmitted?e.emitClose():(e._receiver.on("error",sr),e._receiver.on("finish",sr))}function lr(e){this[Pt]._receiver.write(e)||this.pause()}function ur(){const e=this[Pt];e._readyState=Yt.CLOSING,e._receiver.end(),this.end()}function dr(){const e=this[Pt];this.removeListener("error",dr),this.on("error",Dt),e&&(e._readyState=Yt.CLOSING,this.destroy())}const{tokenChars:pr}=je;var mr={parse:function(e){const t=new Set;let r=-1,n=-1,i=0;for(;i<e.length;i++){const s=e.charCodeAt(i);if(-1===n&&1===pr[s])-1===r&&(r=i);else if(0===i||32!==s&&9!==s){if(44!==s)throw new SyntaxError(`Unexpected character at index ${i}`);{if(-1===r)throw new SyntaxError(`Unexpected character at index ${i}`);-1===n&&(n=i);const s=e.slice(r,n);if(t.has(s))throw new SyntaxError(`The "${s}" subprotocol is duplicated`);t.add(s),r=n=-1}}else-1===n&&-1!==r&&(n=i)}if(-1===r||-1!==n)throw new SyntaxError("Unexpected end of input");const s=e.slice(r,i);if(t.has(s))throw new SyntaxError(`The "${s}" subprotocol is duplicated`);return t.add(s),t}};const{createHash:gr}=a,{GUID:yr,kWebSocket:_r}=Q,br=/^[+/0-9A-Za-z]{22}==$/;var wr=class extends c{constructor(e,t){if(super(),null==(e={maxPayload:104857600,skipUTF8Validation:!1,perMessageDeflate:!1,handleProtocols:null,clientTracking:!0,verifyClient:null,noServer:!1,backlog:null,server:null,host:null,path:null,port:null,WebSocket:Jt,...e}).port&&!e.server&&!e.noServer||null!=e.port&&(e.server||e.noServer)||e.server&&e.noServer)throw new TypeError('One and only one of the "port", "server", or "noServer" options must be specified');if(null!=e.port?(this._server=l.createServer(((e,t)=>{const r=l.STATUS_CODES[426];t.writeHead(426,{"Content-Length":r.length,"Content-Type":"text/plain"}),t.end(r)})),this._server.listen(e.port,e.host,e.backlog,t)):e.server&&(this._server=e.server),this._server){const e=this.emit.bind(this,"connection");this._removeListeners=function(e,t){for(const r of Object.keys(t))e.on(r,t[r]);return function(){for(const r of Object.keys(t))e.removeListener(r,t[r])}}(this._server,{listening:this.emit.bind(this,"listening"),error:this.emit.bind(this,"error"),upgrade:(t,r,n)=>{this.handleUpgrade(t,r,n,e)}})}!0===e.perMessageDeflate&&(e.perMessageDeflate={}),e.clientTracking&&(this.clients=new Set,this._shouldEmitClose=!1),this.options=e,this._state=0}address(){if(this.options.noServer)throw new Error('The server is operating in "noServer" mode');return this._server?this._server.address():null}close(e){if(2===this._state)return e&&this.once("close",(()=>{e(new Error("The server is not running"))})),void process.nextTick(vr,this);if(e&&this.once("close",e),1!==this._state)if(this._state=1,this.options.noServer||this.options.server)this._server&&(this._removeListeners(),this._removeListeners=this._server=null),this.clients&&this.clients.size?this._shouldEmitClose=!0:process.nextTick(vr,this);else{const e=this._server;this._removeListeners(),this._removeListeners=this._server=null,e.close((()=>{vr(this)}))}}shouldHandle(e){if(this.options.path){const t=e.url.indexOf("?");if((-1!==t?e.url.slice(0,t):e.url)!==this.options.path)return!1}return!0}handleUpgrade(e,t,r,n){t.on("error",Er);const i=void 0!==e.headers["sec-websocket-key"]&&e.headers["sec-websocket-key"],s=+e.headers["sec-websocket-version"];if("GET"!==e.method||"websocket"!==e.headers.upgrade.toLowerCase()||!i||!br.test(i)||8!==s&&13!==s||!this.shouldHandle(e))return Sr(t,400);const o=e.headers["sec-websocket-protocol"];let a=new Set;if(void 0!==o)try{a=mr.parse(o)}catch(e){return Sr(t,400)}const h=e.headers["sec-websocket-extensions"],c={};if(this.options.perMessageDeflate&&void 0!==h){const e=new Re(this.options.perMessageDeflate,!0,this.options.maxPayload);try{const t=Ot.parse(h);t[Re.extensionName]&&(e.accept(t[Re.extensionName]),c[Re.extensionName]=e)}catch(e){return Sr(t,400)}}if(this.options.verifyClient){const o={origin:e.headers[""+(8===s?"sec-websocket-origin":"origin")],secure:!(!e.socket.authorized&&!e.socket.encrypted),req:e};if(2===this.options.verifyClient.length)return void this.options.verifyClient(o,((s,o,h,f)=>{if(!s)return Sr(t,o||401,h,f);this.completeUpgrade(c,i,a,e,t,r,n)}));if(!this.options.verifyClient(o))return Sr(t,401)}this.completeUpgrade(c,i,a,e,t,r,n)}completeUpgrade(e,t,r,n,i,s,o){if(!i.readable||!i.writable)return i.destroy();if(i[_r])throw new Error("server.handleUpgrade() was called more than once with the same socket, possibly due to a misconfiguration");if(this._state>0)return Sr(i,503);const a=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade",`Sec-WebSocket-Accept: ${gr("sha1").update(t+yr).digest("base64")}`],h=new this.options.WebSocket(null);if(r.size){const e=this.options.handleProtocols?this.options.handleProtocols(r,n):r.values().next().value;e&&(a.push(`Sec-WebSocket-Protocol: ${e}`),h._protocol=e)}if(e[Re.extensionName]){const t=e[Re.extensionName].params,r=Ot.format({[Re.extensionName]:[t]});a.push(`Sec-WebSocket-Extensions: ${r}`),h._extensions=e}this.emit("headers",a,n),i.write(a.concat("\r\n").join("\r\n")),i.removeListener("error",Er),h.setSocket(i,s,{maxPayload:this.options.maxPayload,skipUTF8Validation:this.options.skipUTF8Validation}),this.clients&&(this.clients.add(h),h.on("close",(()=>{this.clients.delete(h),this._shouldEmitClose&&!this.clients.size&&process.nextTick(vr,this)}))),o(h,n)}};function vr(e){e._state=2,e.emit("close")}function Er(){this.destroy()}function Sr(e,t,r,n){e.writable&&(r=r||l.STATUS_CODES[t],n={Connection:"close","Content-Type":"text/html","Content-Length":Buffer.byteLength(r),...n},e.write(`HTTP/1.1 ${t} ${l.STATUS_CODES[t]}\r\n`+Object.keys(n).map((e=>`${e}: ${n[e]}`)).join("\r\n")+"\r\n\r\n"+r)),e.removeListener("error",Er),e.destroy()}let xr=null;new TextEncoder;const kr=new TextDecoder,Br=R,Or=P;class Lr{constructor(e,t,r){this.channelManager=r,this.ws=e,e.isAlive=!0,e.txCounter=0,e.rxCounter=0,e.txBytes=0,e.rxBytes=0,e.openTime=Date.now(),this.lastEchoMessage="begin:"+p(),this.ssid=Lr.getID(),this.nick="nop",this.remotePort=t.socket.remotePort,this.chMap=new Map,this.ip=this.getClientIP(t),this.privateNode=!1,this.HOME_CHANNEL="",console.log("### server remocon ip:",this.ip),!function(e){if(0===e.indexOf("0.0.0.0"))return!0;if(0===e.indexOf("127.0.0.1"))return!0;if(0===e.indexOf("192.168."))return!0;if(0===e.indexOf("10."))return!0;if(0===e.indexOf("172.")){if(0===e.indexOf("172.16."))return!0;if(0===e.indexOf("172.17."))return!0;if(0===e.indexOf("172.18."))return!0;if(0===e.indexOf("172.19."))return!0;if(0===e.indexOf("172.20."))return!0;if(0===e.indexOf("172.21."))return!0;if(0===e.indexOf("172.22."))return!0;if(0===e.indexOf("172.23."))return!0;if(0===e.indexOf("172.24."))return!0;if(0===e.indexOf("172.25."))return!0;if(0===e.indexOf("172.26."))return!0;if(0===e.indexOf("172.27."))return!0;if(0===e.indexOf("172.28."))return!0;if(0===e.indexOf("172.29."))return!0;if(0===e.indexOf("172.30."))return!0;if(0===e.indexOf("172.31."))return!0}return!1}(this.ip)?this.HOME_CHANNEL=this.channelManager.addToGlobalIPChannel(this):(this.HOME_CHANNEL=this.channelManager.addToPrivateChannel(this),this.privateNode=!0),e.onclose=e=>{this.channelManager.removeClient(this)},e.on("error",(e=>{console.log("ws.onerror",e,e.code)})),e.on("message",this.onWebSocketMessage.bind(this)),e.on("pong",this.receiveMonitor.bind(this)),e.on("ping",this.receiveMonitor.bind(this)),this.frame("ssid",this.ssid);let n=F(Or("svr","8",q.svr),Or("msg","hello"));this.send(n)}static ssid=1;static getID(){return Lr.ssid++}showMessageLog(e,t){let r="["+this.ssid+this.nick+"] ";if(t){let t="["+q[e[0]]+"] ";e.byteLength>40?console.log(t+r+" LEN:",e.length):console.log(t+r,e)}else console.log(r+"STR: %s",e)}onWebSocketMessage(e,t){let r;if(this.receiveMonitor(e,t),t)switch(r=e[0],r){case q.echo:this.send(e,t);break;case q.loop:let n=e.slice(1);this.send(n,t);break;case q.iam:if(e.byteLength>1){let t=e.slice(1);this.nick=kr.decode(t)}this.iamRespone();break;case q.auth:let i=j(e);console.log(i);let s=e.readUInt16BE(1),o=0,a=F(Or("authObj",{publicKey:"asdf"}));this.response(s,o,a);break;case q.pub:if(e.byteLength>=5){let r=e.readUInt16BE(1),n=e.readUInt16BE(3);if(e.byteLength>=n+5){let i=e.slice(5,5+n);i=kr.decode(i);let s,[o,a]=this.channelManager.broadcastTo(i,this,e,t),h=0;"ok"==o?s=F(Or("receiver","8",a)):(s=F(Or("result",a)),h=255),this.response(r,h,s)}}break;case q.sub:if(e.byteLength>=5){let t=e.readUInt16BE(1),r=e.readUInt16BE(3);if(e.byteLength==r+5){let n=e.slice(5,5+r);n=kr.decode(n);let i=n.split(",");this.channelManager.subscribe(i,this),this.response(t,0)}else this.response(t,255)}break;case q.adm:console.log("svr",this.isAdmin);break;default:console.log("unknown binary cmd",r)}else if(91===e[0])try{let n=JSON.parse(e);if(Array.isArray(n))switch(r=n,r[0]){case"echo":r[1]?(this.lastEchoMessage=r[1],this.frame(...r)):this.frame("echo");break;case"loop":r[1]&&(r.shift(),this.frame(...r));break;case"iam":r[1]&&(this.nick=r[1]),this.iamRespone();break;case"auth":this.authRespose();break;case"pub":r[1]&&this.channelManager.broadcastTo(r[1],this,e,t);break;case"sub":r.length>=2&&(r.shift(),this.channelManager.subscribe(r,this));break;case"unsub":r.shift(),this.channelManager.unsubscribe(r,this);break;case"admin":this.isAdmin&&(r.shift(),this.channelManager.adminCall(this,r))}}catch(e){console.log(e)}}receiveMonitor(e,t){this.ws.rxCounter++,this.ws.rxBytes+=e.byteLength+1,this.ws.isAlive=!0}getClientIP(e){let t=e.headers["x-forwarded-for"],r=e.headers["x-tcp-routed-for"];return null==t&&(t=e.socket.remoteAddress),r&&(t=r),t?(0==t.indexOf("::ffff:")&&(t=t.substring(7)),"::1"==t&&(t="127.0.0.1")):t="0.0.0.0",t}response(e,t,r=new Uint8Array(0)){let n=V([Br("8",q.res),Br("8",t),Br("16",e),r]);this.send(n)}send(e,t){if(1===this.ws.readyState){let r=m(e);if(0==r)return;this.ws.txCounter++,this.ws.txBytes+=r,null!=t?this.ws?.send(e,{binary:t}):this.ws?.send(e)}}bin(...e){}sendJSON(e){let t=JSON.stringify(e);this.send(t)}frame(...e){let t=[];for(let r of e)t.push(r);this.sendJSON(t)}iamRespone(){let e=[];for(let t of this.chMap.keys()){let r=this.chMap.get(t),n=[];r.forEach((e=>n.push(e)));let i={};i[t]=n,e.push(i)}let t={ssid:this.ssid,nick:this.nick,ip:this.ip,chMap:e};this.frame("iam",t)}authRespose(e=0,t=!1){let r={rand:"asdfasdf",time:234234234234};t?this.bin(q.auth,r):this.frame("auth",r)}}process.on("uncaughtException",((e,t)=>{console.log("uncaughtException",e,t)}));class Ir{constructor(){this.privateChannelName=h().substring(0,18),this.publicIPChannelBaseName=h().substring(0,13),this.map=new Map,this.remocons=new Set,this.adminChannelIntervalID=null,this.adminMetricOption=0}addClient(e,t){this.remocons.add(new Lr(e,t,this))}removeClient(e){for(let t of e.chMap.keys())if(this.map.has(t)){const r=this.map.get(t);console.log(`channel [ ${t} ] removes client id: ${e.ssid} `),r.delete(e),this.checker()}this.remocons.delete(e)}broadcastTo(e,t,r,n){let i,s,o=0;if(e.includes("#")){let r=e.split("#");i=r[0]?r[0]:t.HOME_CHANNEL,s=r[1]?r[1]:"#"}else i=e,s="#";if(this.map.has(i)){let e=this.map.get(i);return e.size>=1&&e.forEach((e=>{if(e!==t&&e.chMap.has(i)){e.chMap.get(i).has(s)&&(e.send(r,n),o++)}})),["ok",o]}return console.log("no one subscribed"),["err","No one subscribed."]}broadcastToSubscribed(e,t,r,n){if(this.map.has(e)){let i=this.map.get(e);i.has(t)&&i.size>1&&i.forEach((e=>{e!==t&&e.send(r,n)}))}}addToPrivateChannel(e){let t=this.privateChannelName;return this.subscribe([t],e),this.checker(),t}addToGlobalIPChannel(e){let t=e.ip+this.publicIPChannelBaseName;return this.subscribe([t],e),this.checker(),t}subscribe(e,t){console.log("subscribe: ",e),e.forEach((e=>{let r,n;if(e.includes("#")){let i=e.split("#");r=i[0]?i[0]:t.HOME_CHANNEL,n=i[1]?i[1]:"#",console.log("chInfo",i)}else r=e,n="#";console.log("subscribe: ch,tag ",r,n),this.map.has(r)?this.map.get(r).add(t):this.map.set(r,new Set([t])),t.chMap.has(r)?t.chMap.get(r).add(n):t.chMap.set(r,new Set([n])),r===xr&&(t.isAdmin=!0,t.frame("admin","ok"))})),this.checker()}unsubscribe(e,t){let r,n,i=e[0];if(i.includes("#")){let e=i.split("#");r=e[0]?e[0]:t.HOME_CHANNEL,n=e[1]?e[1]:"#"}else r=i,n="#";console.log("unsub ch,tag",r,n);for(let e of t.chMap){let[r,i]=e;console.log("unsubscribe ",r,i),this.map.has(r)?(console.log("map has"),i.has(n)&&(console.log("match: ch && tagSet ",i),r===t.HOME_CHANNEL&&"#"===n?console.log("homechannel is immortal."):i.delete(n),0==i.size&&(console.log("no more ch tags. remove client from map."),this.map.get(r).delete(t),t.chMap.delete(r)))):console.log("map has not")}this.checker()}has(e){return this.map.has(e)}removeEmptyChannel(){const e=[];this.map.forEach(((t,r)=>{0===t.size&&e.push(r)})),e.length>=1&&e.forEach((e=>{this.map.delete(e)}))}adminCall(e,t=[]){if("t"===t[0]){this.adminChannelIntervalID&&clearInterval(this.adminChannelIntervalID);let e=t[1]>300?t[1]:1e3;this.adminChannelIntervalID=setInterval((e=>{this.adminChannelBroadCast()}),e)}else"c"===t[0]&&(this.adminMetricOption=t[1])}adminChannelBroadCast(){let e={};e.channels=this.getMetric(this.adminMetricOption),e.time=Date.now(),e.timeStamp=p();let t=["pub","admin",e];this.broadcastTo(xr,"",JSON.stringify(t))}getMetric(e=0){let t,r=[];if(0==e?t=this.remocons:1==e||(t=this.map.get(e)),1==e)this.map.forEach(((e,t)=>{let n=[];n=Array.from(e),n=n.map((e=>({ip:e.ip,ssid:e.ssid,nick:e.nick,uptime:Math.trunc((Date.now()-e.ws.openTime)/1e3),tx:e.ws.txCounter,rx:e.ws.rxCounter,txBytes:e.ws.txBytes,rxBytes:e.ws.rxBytes,echo:e.lastEchoMessage})));let i={name:t,clients:n};r.push(i)}));else{let n=[];if(!t)return[{name:"no channel",clients:[]}];n=Array.from(t),n=n.map((e=>({ip:e.ip,ssid:e.ssid,nick:e.nick,uptime:Math.trunc((Date.now()-e.ws.openTime)/1e3),tx:e.ws.txCounter,rx:e.ws.rxCounter,txBytes:e.ws.txBytes,rxBytes:e.ws.rxBytes,echo:e.lastEchoMessage})));let i={name:e,clients:n};r.push(i)}return r}checker(){const e=[];this.map.forEach(((t,r)=>{0===t.size&&e.push(r)})),e.length>=1&&e.forEach((e=>{this.map.delete(e)}))}keys(){return this.map.keys()}}class Tr{constructor(e){this.options=e,this.channelManager=new Ir,this.wss=new wr(e),this.wss.setMaxListeners(0);let t=parseInt(e.pingPeriod);this.pingPeriod=t>=1e3?t:5e4,this.wss.on("error",(e=>{console.error("### ws server error:",e)})),this.wss.on("close",(e=>{clearInterval(this.pingIntervalID),clearInterval(this.monitIntervalID)})),this.wss.on("connection",((e,t)=>{e.isAlive=!0,this.channelManager.addClient(e,t)})),this.pingIntervalID=setInterval((e=>{this.wss.clients.forEach((function(e){if(!1===e.isAlive)return console.log("terminate"),e.terminate();e.txCounter++,e.txBytes++,e.isAlive=!1,e.ping()}))}),this.pingPeriod),this.monitIntervalID=setInterval((e=>{}),5e3)}}Z.NodeWebSocket=Jt;export{Z as Remocon,Tr as RemoconServer};
